<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Zoom MS-50G / 60B / 70CDR Patch Editor</title>
<link rel="icon" href="./images/icon.png" />
<!--<link href="https://fonts.googleapis.com/css?family=Audiowide" rel="stylesheet">-->
<!--<link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">-->
<!--<script src="bower_components/webcomponentsjs/webcomponents-lite.js"></script>-->
<script>UseWebAudioControlsMidi=0</script>
<script src="./js/webaudio-controls.js"></script>
<script src="./js/jszip.min.js"></script>
<script>
//
// Zoom MS-50G / 60B / 70CDR
//
// MIDI commands
//  These commands are inferred by irresponsible experiment and not garanteed.
//
//  ProgramChange : [0xc0,pp]
//     Select patch by MIDI Program Change pp=patch number (0-49)
//  IdentityRequest : [0xf0,0x7e,0x00,0x06,0x01,0xf7]
//     Identity Request (MIDI Universal System Exclusive). It return [0xf0,0x7e,0x00,0x06,0x02,0x52,0x58,0x00,0x00,0x00,0x33,0x2e,0x30,0x30,0xf7]
//  TunerMode : [0xb0,0x4a,mm]
//     Tuner Mode On/Off. MIDI Control Change CC#74. mm<64:off mm>=64:on
//  WritePatch :          [0xf0,0x52,0x00,0x58,0x28,effect1,effect2,...effect6,patch-name,0xf7] (146bytes)
//     Write 146bytes patch-data to current program.
//     It consist of [0xf8,0x52,0x00,0x58,0x28, effect1,effect2,...effect6, patch-name,0xf7]
//  RequestPatch :        [0xf0,0x52,0x00,0x58,0x29,0xf7]
//     Requst patch-data of current program. it returns 146 bytes patch-data (same as WritePatch command)
//  EffectEnable :        [0xf0,0x52,0x00,0x58,0x31,nn,0x00,mm,0x00,0xf7]
//     Effect On/Off. It seems effective only for effect1-3.  nn=effect#(0-2) mm=0:off mm=1:on
//  ParameterEdit :       [0xf0,0x52,0x00,0x58,0x31,nn,pp,vvLSB,vvMSB,0xf7]
//     Parameter value edit. nn=effect# pp=param#+2 vv=value. value range is depends on each effect.
//  Patch Store :      [0xf0,0x52,0x00,0x58,0x32,0x01,0x00,0x00,pp,0x00,0x00,0x00,0x00,0x00,0xf7]
//     Message (Storing...)
//  RequestCurrentProgram : [0xf0,0x52,0x00,0x58,0x33,0xf7]
//     Request current bank&program. It returns [0xb0,0x00,0x00, 0xb0,0x20,0x00, 0xc0,pp] pp=program#(0-49) bank is always 0
//  ParameterEditEnable : [0xf0,0x52,0x00,0x58,0x50,0xf7]
//     Parameter value edit enable. Needed before Parameter Edit.
//  ParameterEditDisable :[0xf0,0x52,0x00,0x58,0x51,0xf7]
//     Parameter value edit disable.
//  ??? :                 [0xf0,0x52,0x00,0x58,0x60,0xf7]
//

</script><script src="./js/apatch.js"></script><script>

var midiif=null;
var midioutputs=[];
var midiin=null;
var midirecv="";
var patches=[];
var clipboard=new apatch();
var inst=null;
var currentpatch=-1;
var currenteffect=0;
var currentparam=0;
var timer,timerprg;
var dragtarget=null;
var ready=false;
var instanceid=null;
var abort=false;
var url;
var autosave=0;

var patchkeymap=[
  "a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t",
  "A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T",
  "1","2","3","4","5","6","7","8","9","0"];
var effectkeymap=["F1","F2","F3","F4","F5","F6"];
var tunerkey="F9";
var dirty=0;

var emptypatch=[
  0xf0,0x52,0x00,0x58,0x28,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x40,0x05,0x0f,0x45,0x00,0x6d,0x70,0x74,0x79,0x20,0x20,
  0x20,0x00,0x20,0x20,0x00,0xf7
];

var bampcab=[
  { //ver 1.00
    max:[16,32,48,96,112,192,0],
    disp:["AG 8x10","BM 4x12","HA 4x10","AC 1x18","AL 4x10","MB 1x12","OFF"],
  },
  { //ver 2.00
    max:[16,32,48,96,112,192,64,80,128,144,160,176,0],
    disp:["AG 8x10","BM 4x12","HA 4x10","AC 1x18","AL 4x10","MB 1x12","SWR 4x10","AG 1x15","PT 1x15","SB 4x12","GK 4x10","E 4x10","OFF"],
  },
];
var gampcab=[
  { //ver 1.00
    max:[8,16,48,80,144,240,304,320,0],
    disp:["FD COMBO 2x12","DLX-R 1x12","US BLUES 4x10","VX JMI 2x12","TW ROCK 1x12","MS 1959 4x12","DZ DRIVE 4x12","ALIEN 4x12","OFF"],
  },
  { //ver 3.00
    max:[8,16,32,48,64,80,96,112,128,144,160,176,192,208,224,240,256,272,288,304,320,336,0],
    disp:["FD COMBO 2x12","DLX-R 1x12","FD VIBRO 2x10","US BLUES 4x10","VX COMBO 2x12","VX JMI 2x12","BG CRUNCH 1x12","MATCH 30 2x12","CAR DRIVE 1x12","TW ROCK 1x12","TONE CITY 4x12","HW STACK 4x12","TANGERINE 4x12","B-BRKR 2x12","MS CRUNCH 4x12","MS 1959 4x12","MS DRIVE 4x12","BGN DRIVE 4x12","BG DRIVE 4x12","DZ DRIVE 4x12","ALIEN 4x12","REVO-1 4x12","OFF"],
  }
];
</script><script src="./js/effectslist.js"></script><script>

function dumpeff(){
  console.log("name,group,ms50g,ms60b,ms70cdr,dsp(%),description")
  for(i in effectlist){
    var ef=effectlist[i];
    var v50=ef.ver&0xf;
    var v60=(ef.ver>>4)&0xf;
    var v70=(ef.ver>>8)&0xf;
    console.log("\""+ef.name+"\","+ef.group+","+((v50>0)?v50:"")+","+((v60>0)?v60:"")+","+((v70>0)?v70:"")+","+(100/ef.dsp).toFixed(1)+","+ef.title);
  }
}
function MidiIf(ma){
  this.midiaccess=ma;
  this.midiout=null;
  this.devid=0x58;
  this.version=3;
  this.devstr="50g";
  this.sysexhead="f0520058";
  this.que=[];
  this.scan=-1;
  this.dump=1;
  this.supress=0;
  this.waitdata=null;
  this.callback=null;
  this.ready=0;
  this.pcnt=0;
  this.workpatch=new apatch();
  this.midiinport=null;
  this.midiaccess.onstatechange=function(ev){
    console.log("StateChange",ev)
  };
  this.instSet=function(){
    for(var id in effectlist){
      var v=effectlist[id].ver;
      switch(this.devid){
      case 0x58: v=v&0xf; break;
      case 0x5f: v=(v>>4)&0xf; break;
      case 0x61: v=(v>>8)&0xf; break;
      }
      var el=document.getElementById("e_"+id);
      if(el){
        if(v==0||v>this.version){
          effectlist[id].install=-2;
          document.getElementById("e_"+id).classList.add("notinstall");
        }
        else if(this.devid!=0x58){
          effectlist[id].install=1;
          document.getElementById("e_"+id).classList.add("install");
        }
      }
    }
  }
  this.recv=function(ev){
    if(abort)
      return;
    midirecv=MakeStr(ev.data);
    switch(this.dump){
    case 1:
      if(ev.data[0]>=0xf0)
        console.log(midirecv);
      break;
    case 2:
      console.log(midirecv);
      break;
    }
    if((!this.supress ||this.waitdata=="c0") && ev.data[0]==0xc0){
      if(currentpatch!=ev.data[1] && this.scan<0){
        SetPatchFocus(0);
        currentpatch=ev.data[1];
        DispPatch();
        SetPatchFocus(1);
      }
    }
    if(midirecv.indexOf(this.sysexhead+"31")==0){
      if(ev.data[6]==0)
        SetEffectState(currentpatch,ev.data[5],0);
      if(ev.data[6]>=2){
        var v=(ev.data[7]&0x7f)+((ev.data[8]&0x7f)<<7);
        SetParamVal(currentpatch,ev.data[5],ev.data[6],v);
        if(this.dump==3){
          console.log(ev.data[5],ev.data[6],v);
        }
        DispPatch();
      }
    }
    else if(midirecv.indexOf("f07e00060252")==0){
      var v=String.fromCharCode(ev.data[10],ev.data[11],ev.data[12],ev.data[13]);
      this.version=parseFloat(v);
      switch(this.devid=ev.data[6]){
      case 0x58:
        this.sysexhead="f0520058";
        this.devstr="50g";
        this.instSet();
        document.getElementById("device").innerHTML="MS-50G";
        document.getElementById("effects").rows[4].style.display="";
        document.getElementById("effects").rows[5].style.display="";
        for(var id in effectlist){
          var ef=effectlist[id];
          if(ef.group=="AMP" && (ef.ver&0xf)){
            ef.param[7].max=gampcab[(v>=3)?1:0].max;
            ef.param[7].disp=gampcab[(v>=3)?1:0].disp;
          }
        }
        break;
      case 0x5f:
        this.sysexhead="f052005f";
        this.devstr="60b";
        this.instSet();
        document.getElementById("device").innerHTML="MS-60B";
        document.getElementById("effects").rows[4].style.display="none";
        document.getElementById("effects").rows[5].style.display="none";
        for(var id in effectlist){
          var ef=effectlist[id];
          if(ef.group=="AMP" && (ef.ver&0xf0)){
            ef.param[7].max=bampcab[(v>=2)?1:0].max;
            ef.param[7].disp=bampcab[(v>=2)?1:0].disp;
          }
        }
        break;
      case 0x61:
        this.sysexhead="f0520061";
        this.devstr="70cdr";
        this.instSet();
        document.getElementById("device").innerHTML="MS-70CDR";
        document.getElementById("effects").rows[4].style.display="";
        document.getElementById("effects").rows[5].style.display="";
        break;
      }
      inst.ShowAll(false);
      document.getElementById("firmver").innerHTML=v;
    }
    else if(midirecv.indexOf(this.sysexhead+"28")==0){
      var name=MakeName(ev.data);
      if(this.scan>=0){
        document.getElementById("waitmsg").innerHTML="Scanning Patches...("+this.scan+"/50)";
        patches[this.scan].ReadBin(ev.data);
        DispPatchName(this.scan);
        for(var ii=0;ii<6;++ii){
          var id=patches[this.scan].GetEffectId(ii);
          if(id && effectlist[id]){
            effectlist[id].install=1;
            var el=document.getElementById("e_"+id);
            if(el) el.classList.add("install");
          }
        }
        ++this.scan;
        if(this.scan>49){
          this.scan=-1;
          this.ready=1;
          midiif.Send([0xc0,currentpatch]);
          SetPatchFocus(1);
          DispPatch();
          document.getElementById("waitbase").style.display="none";
          ready=true;
          for(i=0;i<6;++i){
            var cell=document.getElementById("fnam"+(i+1));
            var cell2=document.getElementById("fnum"+(i+1));
            cell.oncontextmenu=function(ev){
              currenteffect=parseInt(ev.target.id[4])-1;
              SetCurrentEffect(currenteffect);
              midiif.SendCurrentPatch();
              PopupEffectMenu(ev.target);
              ev.preventDefault();
            };
            cell.ondblclick=function(ev){
              document.getElementById("effectpanelmsg").innerHTML="Add / Replace Effect";
              document.getElementById("effectpanelbase").style.display="block";
            };
            cell.onclick=function(ev){
              currenteffect=parseInt(ev.target.id[4])-1;
              SetCurrentEffect(currenteffect);
              ToggleEffect(currenteffect);
              UpdateFocus();
              DispPatchName(currentpatch);
              ev.preventDefault();
            };
            cell2.onclick=cell2.oncontextmenu=function(ev){
              currenteffect=parseInt(ev.target.id[4])-1;
              PopupEffectMenu(ev.target);
              SetCurrentEffect(currenteffect);
              midiif.SendCurrentPatch();
              ev.stopPropagation();
              ev.preventDefault();
            };
          }
        }
        else{
          this.que.push([0xc0,this.scan]);
          this.que.push([0xf0,0x52,0,this.devid,0x29,0xf7]);
        }
      }
      else{
        patches[currentpatch].ReadBin(ev.data);
        for(var ii=0;ii<6;++ii){
          var id=patches[currentpatch].GetEffectId(ii);
          if(id && effectlist[id]){
            effectlist[id].install=1;
            var el=document.getElementById("e_"+id);
            if(el) el.classList.add("install");
          }
        }
        DispPatch();
        DispPatchName(currentpatch);
      }
    }
    if(this.waitdata){
      if(midirecv.indexOf(this.waitdata)==0){
        this.supress=0;
        this.waitdata=null;
        if(this.callback){
          this.callback(ev.data,midirecv);
        }
      }
    }
  };
  this.StartScan=function(){
    console.log("StartScan")
    if(!this.midiout)
      return;
    document.getElementById("waitmsg").innerHTML="";
    document.getElementById("waitbase").style.display="block";
    this.SendDirect([0xf0,0x7e,0x00,0x06,0x01,0xf7]);
    setTimeout(function(){
      this.SendDirect([0xf0,0x52,0x00,this.devid,0x50,0xf7]);
      this.scan=0;
      setTimeout(function(){
        this.SendWait([0xf0,0x52,0x00,this.devid,0x33,0xf7],"c0",function(dat){
          this.norg=currentpatch=dat[1];
          this.que.push([0xf0,0x52,0x00,this.devid,0x50,0xf7]);
          this.que.push([0xc0,this.scan]);
          this.que.push([0xf0,0x52,0,this.devid,0x29,0xf7]);
        }.bind(this));
      }.bind(this),100);
    }.bind(this),200);
  };
  this.SendDirect=function(d){
    if(this.dump==4)
      console.log("S:"+MakeStr(d));
    if(this.midiout)
      this.midiout.send(d);
  };
  this.Send=function(d){
    if(this.que.length>2){
      var d2=this.que[this.que.length-1];
      if(d[0]==0xf0 && d2[0]==0xf0){
        if(d[4]==0x28 && d2[4]==0x28){
          this.que.pop();
        }
        else if(d[4]==0x31 && d2[4]==0x31 && d[5]==d2[5] && d[6]==d2[6]){
          this.que.pop();
        }
      }
    }
    this.que.push(d);
  };
  this.RequestPatch=function(){
    this.Send([0xf0,0x52,0x00,this.devid,0x29,0xf7]);
//    this.SendWait([0xf0,0x52,0x00,this.devid,0x29,0xf7],this.sysexhead+"28",null);
  };
  this.SendParamChange=function(f,p,v){
    var cmd=[0xf0,0x52,0x00,this.devid,0x31,f,p,v&0x7f,(v>>7)&0x7f,0xf7];
    this.Send(cmd);
  };
  this.SendCurrentPatch=function(){
    this.Send(patches[currentpatch].MakeBin(this.devid));
  };
  this.SendCurrentPatchVerify=function(callback){
    var o=[];
    var len=(midiif.devid==0x5f)?4:6;
    for(var i=0;i<len;++i){
      o.push(patches[currentpatch].GetEffectId(i));
    }
    this.SendCurrentPatch();
    setTimeout(function(){
      this.SendWait([0xf0,0x52,0x00,this.devid,0x29,0xf7],this.sysexhead+"28",function(dat,str){
        var s="";
        this.workpatch.ReadBin(dat);
        for(var j=0;j<len;++j){
          if(o[j]!=patches[currentpatch].GetEffectId(j)){
            var el=document.getElementById("e_"+o[j]);
            if(el){
              el.classList.add("notinstall");
              if(effectlist[o[j]].install==0)
                effectlist[o[j]].install=-1;
              s+="["+effectlist[o[j]].name+"]";
            }
          }
        }
        if(callback)
          callback(s.length?s:null);
      })
    }.bind(this),200);
  };
  this.SendWait=function(sd,rv,cb){
    this.supress=1;
    this.callback=cb;
    this.waitdata=rv;
    this.SendDirect(sd);
  };
  this.timer=function(){
    if(abort)
      return;
    var id=0;
    var cookies=document.cookie.split(";");
    for(var i=0;i<cookies.length;++i){
      if(cookies[i].indexOf("patcheditor=")==0){
        id=parseInt(cookies[i].split("=")[1]);
      }
    }
    if(id!=0&&id!=instanceid){
      AlertMsg("Another Patch Editor is launched.<br/> This instance is no more effective. <br/>Reload?",function(){
        window.location.href=url;
      });
      abort=true;
      return;
    }
    if(!this.midiout)
      return;
    if(this.supress)
      return;
    if(this.waitdata)
      return;
    if(this.scan>=0){
      if(this.que.length>0){
        var d=this.que.shift();
        this.SendDirect(d);
      }
      return;
    }
    else if(this.que.length>0){
      var d=this.que.shift();
      this.SendDirect(d);
    }
    else{
      if(this.ready){
        if(dirty>0){
          if(++dirty>40){
            dirty=0;
            if(autosave)
              StorePatch(currentpatch);
          }
        }
        this.SendWait([0xf0,0x52,0x00,this.devid,0x33,0xf7],"c0");
      }
    }
  };
  this.PortScan=function(){
    midioutputs=[];
    document.getElementById("midiport").innerHTML="";
    var i=0;
    var outputIterator=this.midiaccess.outputs.values();
    for(var o=outputIterator.next(); !o.done; o=outputIterator.next()) {
        midioutputs[i]=o.value;
        var op=new Option(o.value.name);
        if(o.value.name.startsWith("ZOOM MS Series"))
          op.selected=true;
        else
          op.disabled=true;
        document.getElementById("midiport").options[i]=op;
        i++;
    }
    var inputIterator=this.midiaccess.inputs.values();
    for(var ip=inputIterator.next(); !ip.done; ip=inputIterator.next()){
      if(ip.value.name.startsWith("ZOOM MS Series") && this.midiinport==null){
        this.midiinport=ip.value;
        this.recvhander=this.recv.bind(this);
        this.midiinport.onmidimessage=this.recvhander;
      }
    }
  };
  this.SelectPort=function(){
    var idx=document.getElementById("midiport").selectedIndex;
    if(idx>=0 && midioutputs.length>0){
      this.midiout=midioutputs[idx];
      if (!this.midiout.name.startsWith("ZOOM MS Series"))
        this.midiout=null;
    }
  };
  this.PortScan();
  this.SelectPort();
  if(!this.midiout)
    AlertMsg("<br/>MIDI port is not found.<br/>Retry after connect ZOOM MS device.");
  this.timerid=setInterval(this.timer.bind(this),80);
}

function MakeStr(b){
  var str="";
  for(var j=0;j<b.length;++j)
    str+=("00"+b[j].toString(16)).substr(-2);
  return str;
}
function MakeName(b){
  var name="";
  var len=b.length;
  for(var j=0;j<13;++j){
    var c=b[((len>=146)?132:91)+j];
    if(c)
      name+=String.fromCharCode(c);
  }
  return name;
}
function MakeBin(s,len){
  var bin=[];
  s=s.replace(/[\x00-\x20\x7f-\x9f]/g, '');
  for(var j=0;j<s.length&&j<len*2;j+=2)
    bin.push(parseInt(s.substr(j,2),16));
  return bin;
}
function Init(){
  var i;
  if(typeof(nw)!="undefined"){
    var nwgui= require("nw.gui");
    nwgui.Window.get().on('new-win-policy', function(frame, url, policy) {
      policy.ignore();
      nwgui.Shell.openExternal(url);
    });
  }
  document.getElementById("github2").addEventListener("click",()=>{OpenUrl("https://github.com/g200kg/zoom-ms-utility")});
  if(!navigator.requestMIDIAccess){
    AlertMsg("This browser does not support Web MIDI API. Please use latest Chrome.");
    return;
  }
  url=location.href;
  instanceid=""+(Math.random()*1000000)|0;
  document.cookie="patcheditor="+instanceid;
  document.cookie="max-age=604800";
  var cookies=document.cookie.split(";");
  for(i=0;i<cookies.length;++i){
    if(cookies[i].indexOf("autosave=")==0){
      var as=parseInt(cookies[i].split("=")[1]);
      // if(as==0)
        // AutoSave();  //AutoSave force disable on start
    }
  }
  navigator.requestMIDIAccess({sysex:true}).then(
      function(ma){midiif=new MidiIf(ma);},
      function(e){
        AlertMsg("requestMIDIAccess Error.<br/><br/><img src='./images/mididisableicon.png' align='left' style='margin:5px'/>"
        + "If an icon of keyboard with 'x' mark is displayed at the right end of the address bar, "
        + "click the icon, clear setting, reload and allow 'use MIDI device'."
        );
      },
    );
  for(i=0;i<50;++i)
    patches[i]=new apatch();
  // AutoSave();
  for(i=0;i<6;++i){
    var ef=document.getElementById("fnam"+(i+1));
    var im=document.getElementById("fimg"+(i+1));
    ef.draggable=true;
    im.draggable=false;
    ef.ondragstart=function(ev){
      ev.dataTransfer.setData("text",ev.target.id);
      this.classList.add("drag");
      currenteffect=parseInt(this.id[4])-1;
      for(var j=0;j<6;++j){
        var ef=document.getElementById("fnam"+(j+1));
        ef.ondragend=function(ev){
          this.classList.remove("drag");
          for(var jj=0;jj<6;++jj){
            var dst=document.getElementById("fnam"+(jj+1));
            dst.ondragenter=dst.ondragleave=dst.ondragover=dst.ondrop=null;
          }
        };
        ef.ondragenter=function(ev){
          var d=parseInt(ev.target.id[4])-1;
          if(d>currenteffect)
            this.classList.toggle("overdown");
          else if(d<currenteffect){
            this.classList.toggle("overup");
          }
        };
        ef.ondragleave=function(ev){
          var d=parseInt(ev.target.id[4])-1;
          if(d>currenteffect)
            this.classList.toggle("overdown");
          else if(d<currenteffect)
            this.classList.toggle("overup");
        };
        ef.ondragover=function(ev){
          ev.preventDefault();
        };
        ef.ondrop=function(ev){
          this.classList.remove("overup");
          this.classList.remove("overdown");
          var s=parseInt(event.dataTransfer.getData("text")[4])-1;
          var d=parseInt(ev.target.id[4])-1;
          if(s!=d){
            if(s>d){
              var e=GetEffect(currentpatch,s);
              for(var i=s;i>d;--i)
                SetEffect(currentpatch,i,GetEffect(currentpatch,i-1));
              SetEffect(currentpatch,d,e);
              SetCurrentEffect(d);
              DispPatchName(currentpatch);
              midiif.SendCurrentPatch();
              dirty=1;
            }
            else{
              var e=GetEffect(currentpatch,s);
              for(var i=s;i<d;++i)
                SetEffect(currentpatch,i,GetEffect(currentpatch,i+1));
              SetEffect(currentpatch,d,e);
              SetCurrentEffect(d);
              DispPatchName(currentpatch);
              midiif.SendCurrentPatch();
              dirty=1;
            }
          }
          ev.preventDefault();
        };
      }
    };
    var tab=document.getElementById("effects");
    for(var j=0;j<9;++j){
      var p=tab.rows[i].cells[j+2].childNodes[0];
      var c="f"+(i+1)+"p"+(j+1);
      var k=document.getElementById(c+"k");
      var s=document.getElementById(c+"s");
      var v=document.getElementById(c+"v");
      p.onclick=p.oncontextmenu=function(ev){
        var id=ev.target.id;
        if(id[0]!="f")
          id=ev.target.parentNode.parentNode.id;
        currenteffect=parseInt(id[1])-1;
        currentparam=parseInt(id[3])-1;
        SetCurrentEffect(currenteffect);
        midiif.Send(patches[currentpatch].MakeBin(midiif.devid));
        UpdateFocus();
        ev.preventDefault();
      };
      k.valuetip=0;
      k.oninput = function(k){
        var f=parseInt(k.target.id[1]);
        var p=parseInt(k.target.id[3]);
        SetCurrentEffect(f-1);
        if(k.target.tab){
          var v=k.target.tab[k.target.value|0];
          SetParamVal(currentpatch,f-1,p+1,v);
        }
        else
          SetParamVal(currentpatch,f-1,p+1,k.target.value);
        DispPatch();

        if(f<=3 && f-1==currenteffect){
          midiif.SendParamChange(f-1,p+1,patches[currentpatch].GetParamVal(f-1,p+1));
        }
        else{
          midiif.SendCurrentPatch();
          currenteffect=f-1;
          dirty=1;
        }
      };
      if(s){
        s.onchange=function(s){
          var f=parseInt(s.target.id[1]);
          var p=parseInt(s.target.id[3]);
          SetCurrentEffect(f-1);
          SetParamVal(currentpatch,f-1,p+1,s.target.value);
          DispPatch();
          midiif.SendCurrentPatch();
          dirty=1;
        }
      }

      v.ondblclick=function(ev){
        var f=parseInt(ev.target.id[1]);
        var p=parseInt(ev.target.id[3]);
        var id=patches[currentpatch].GetEffectId(f-1);
        var ef=effectlist[id];
        var par=ef.param[p-1];
        PopupEdit(f,p,par);
      }

    }
  }
  for(i=0;i<50;++i){
    for(var ii=0;ii<6;++ii){
      var id=patches[i].GetEffectId(ii);
      if(id){
        effectlist[id].install=1;
        document.getElementById("e_"+id).classList.add("install");
      }
    }
    var cell=document.getElementById((i+1)+"nam");
    for(var f=0;f<6;++f){
      var c=document.createElement("div");
      c.setAttribute("style","right:"+(f*5)+"px");
      c.id=(i+1)+"_"+(f+1);
      c.setAttribute("class","eficon");
      cell.parentNode.appendChild(c);
    }
    var btn=document.getElementById((i+1)+"btn");
      cell.oncontextmenu=function(ev){
      PopupPatchMenu2(ev.target);
      ev.preventDefault();
    };
    cell.onclick=function(ev){
      document.getElementById("popuppatch").style.display="none";
      SelectPatch(parseInt(ev.target.id)-1);
    };
    cell.onmousedown=function(ev){
      document.getElementById("popuppatch").style.display="none";
      SelectPatch(parseInt(ev.target.id)-1);
    };
    btn.onmousedown=function(ev){
      document.getElementById("popuppatch").style.display="none";
      SelectPatch(parseInt(ev.target.id)-1);
    }
    btn.onclick=btn.oncontextmenu=function(ev){
      SelectPatch(parseInt(ev.target.id)-1);
      PopupPatchMenu2(ev.target);
      ev.stopPropagation();
      ev.preventDefault();
    };
    cell.draggable=true;
    cell.ondragstart=function(ev){
      ev.dataTransfer.setData("text",ev.target.id);
      this.classList.add("drag");
      for(var j=0;j<50;++j){
        var c=document.getElementById((j+1)+"nam");
        c.ondragenter=function(ev){this.classList.add("over");};
        c.ondragleave=function(ev){this.classList.remove("over");};
        c.ondragover=function(ev){ev.preventDefault();};
        c.ondrop=function(ev){
          this.classList.remove("over");
          var s=parseInt(event.dataTransfer.getData("text"));
          var d=parseInt(ev.target.id);
          if(s!=d){
            PopupPatchMenu(ev.target);
            dragtarget=ev.target;
          }
          ev.preventDefault();
        };
        c.ondragend=function(ev){
          this.classList.remove("over");
          this.classList.remove("drag");
          for(var jj=0;jj<50;++jj){
            cc=document.getElementById((jj+1)+"nam");
            cc.ondragenter=cc.ondragleave=cc.ondragover=cc.ondrop=cc.ondragend=null;
          }
        };
      }
    };
  }
  var p=document.getElementById("efpanel0");
  for(var id in effectlist){
    var ef=effectlist[id];
    var e=document.createElement("div");
    var im1="./images/50v"+(ef.ver&0xf)+".png";
    var im2="./images/60v"+((ef.ver>>4)&0xf)+".png";
    var im3="./images/70v"+((ef.ver>>8)&0xf)+".png";
    e.innerHTML="<div class='dspbar'></div><img src='./images/"+ef.name.replace(/ /g,"_")+".png' draggable='false'/><div>"+ef.name+"</div><img class='mk50' src='"+im1+"'/><img class='mk60' src='"+im2+"'/><img class='mk70' src='"+im3+"'/>";
    e.setAttribute("class","efitem");
    e.setAttribute("title",ef.title);
    var b=e.childNodes[0];
//    var d=(ef.dspmax+ef.dspmin)*.5;
    var d=1/ef.dsp;
    b.style.height=d*40+"px";
    var r=(d>=0.33?255:d*3*255)|0;
    var g=(d>=0.5?0:(d>=0.33?255-(d-0.33)*5.9*255:255))|0;
    b.style.background=ef.col="rgb("+r+","+g+",0)";
    b.style.borderTop=((40-d*40)|0)+"px solid #000";
    var div=document.getElementById("ef"+ef.group);
    if(div){
      div.appendChild(e);
      e.id="e_"+id;
      e.onclick=function(ev){
        if(document.getElementById("effectpanelmsg").innerHTML!="Install Check"){
          var id=ev.target.id;
          if(!id)
            id=ev.target.parentNode.id;
          id=parseInt(id.substring(2));
          var ef=GetEffectFromId(id);
          SetEffect(currentpatch,currenteffect,ef);
          SetCurrentEffect(currenteffect);
          EffectPanelCancel();
          if(effectlist[id].install==0){
            effectlist[id].install=-1;
            document.getElementById("e_"+id).classList.add("notinstall");
          }
          midiif.SendCurrentPatch();
          midiif.RequestPatch();
          dirty=1;

//?
//          midiif.SendCurrentPatchVerify(null,function(s){
//            AlertMsg("Effect "+s+" is not installed.");
//          });
        }
      }
    }
  }
  ShowDoc(GetLang()=="ja"?"ja":"en");
  inst=new InstallChecker();
  document.addEventListener("click",function(ev){
    PopupEffectCancel();
    PopupPatchCancel();
    PopupPatchCancel2();
    document.getElementById("popupeditpanel").style.display="none";
  });
  document.addEventListener("keydown",function(ev){
    if(ready){
      var p;
      if(document.getElementById("inputbase").style.display=="block"
        || document.getElementById("confirmbase").style.display=="block"
        || document.getElementById("textareabase").style.display=="block"
        || document.getElementById("popupeditpanel").style.display=="block"
        ){
        if(ev.key=="Escape"){
          document.getElementById("inputbase").style.display="none";
          document.getElementById("confirmbase").style.display="none";
          document.getElementById("textareabase").style.display="none";
          document.getElementById("popupeditpanel").style.display="none";
        }
        return;
      }
      if(ev.ctrlKey||ev.altKey)
        return;
      if(ev.key=="ArrowUp"||ev.key=="ArrowDown"||ev.key=="PageUp"||ev.key=="PageDown"){
        if(currenteffect>=0&&currentparam>=0){
          var i="f"+(currenteffect+1)+"p"+(currentparam+1);
          var k=document.getElementById(i+"k");
          var s=document.getElementById(i+"s");
          if(k){
            var p1=Math.max((((k.max-k.min)*0.05)|0),1);
            var p2=Math.max((((k.max-k.min)*0.01)|0),1);
            var v=k.value;
            switch(ev.key){
            case "ArrowUp":
              if(ev.shiftKey)
                v=Math.min(v+=p1,k.max);
              else
                v=Math.min(v+=1,k.max);
              break;
            case "ArrowDown":
              if(ev.shiftKey)
                v=Math.max(v-=p1,k.min);
              else
                v=Math.max(v-=1,k.min);
              break;
            case "PageUp":
              v=Math.min(v+=p1,k.max);
              break;
            case "PageDown":
              v=Math.max(v-=p1,k.min);
              break;
            }
            if(k.setValue)
              k.setValue(v,true);
          }
        }
      }
      if(ev.key=="ArrowLeft" || ev.key=="ArrowRight"){
        p=currentpatch;
        if(ev.key=="ArrowLeft"){
          if(--p<0)
            p=49;
        }
        else{
          if(++p>=50)
            p=0;
        }
        SelectPatch(p);
        ev.preventDefault();
      }
      if(ev.key==tunerkey){
        document.getElementById("tunerbtn").click();
      }
      var p=patchkeymap.indexOf(ev.key);
      if(p>=0){
        SelectPatch(p);
        ev.preventDefault();
      }
      var e=effectkeymap.indexOf(ev.key);
      if(e>=0){
        SetCurrentEffect(e);
        ToggleEffect(e);
        ev.preventDefault();
      }
    }
  });
}
function Scan(){
  midiif.StartScan();
}
function StateChange(){
  console.log("StateChange");
}
function UpdateFocus(){
  var tab=document.getElementById("effects");
  for(f=0;f<6;++f){
    for(p=0;p<9;++p){
      var cell=tab.rows[f].cells[p+2].childNodes[0];
      if(f==currenteffect&&p==currentparam)
        cell.classList.add("pfocus");
      else
        cell.classList.remove("pfocus");
    }
  }
}
function AlertMsg(msg,callback){
  document.getElementById("alertmsg").innerHTML=msg;
  if(callback)
    document.getElementById("alertok").onclick=callback;
  else
    document.getElementById("alertok").onclick=function(){document.getElementById("alertbase").style.display="none"};
  document.getElementById("alertbase").style.display="block";
}
function Confirm(msg,callback,pos){
  document.getElementById("confirmmsg").innerHTML=msg;
  var st=document.getElementById("confirmpanel").style;
  if(pos){
    st.left=pos.x+"px",st.top=pos.y+"px";
    st.margin="0";
  }
  else{
    st.left=st.right=st.top=st.bottom="0";
    st.margin="auto";
  }
  document.getElementById("confirmok").onclick=callback;
  document.getElementById("confirmbase").style.display="block";
}
function PopupEffectMenu(tar){
  currenteffect=parseInt(tar.id[4])-1;
  UpdateFocus();
  var rc=tar.getBoundingClientRect();
  var e=document.getElementById("popupeffect");
  e.style.display="block";
  e.style.left=(rc.right+5+window.pageXOffset)+"px";
  e.style.top=(rc.top-20+window.pageYOffset)+"px";
}
function PopupEffectCancel(){
  document.getElementById("popupeffect").style.display="none";
}
function EffectPanelCancel(){
  document.getElementById("effectpanelbase").style.display="none";
}
function PopupEffectDelete(){
  var tar=document.getElementById("fnam"+(currenteffect+1));
  var rc=tar.getBoundingClientRect();
  var panel=document.getElementById("confirmpanel");
  Confirm("Delete Effect Unit ?",function(ev){
    var n=(midiif.devid==0x5f)?4:6;
    for(var j=currenteffect;j<n-1;++j){
      for(var i=0;i<11;++i){
        SetParamVal(currentpatch,j,i,GetParamVal(currentpatch,j+1,i));
      }
    }
    SetParamVal(currentpatch,n-1,0,1);
    for(var i=1;i<10;++i)
      SetParamVal(currentpatch,n-1,i,0);
    SetCurrentEffect(currenteffect);
    DispPatch();
    DispPatchName(currentpatch);
    midiif.SendCurrentPatch();
    midiif.RequestPatch();
    ev.target.parentNode.parentNode.style.display="none";
    dirty=1;
  },
  {x:(rc.left-20+window.pageXOffset),y:(rc.top+40+window.pageYOffset)});
}
function PopupEffectReplace(){
  document.getElementById("effectpanelmsg").innerHTML="Add / Replace Effect";
  document.getElementById("effectpanelbase").style.display="block";
}
function PopupEffectInsert(){
  var efmax=(midiif.devid==0x5f)?4:6;
  if(patches[currentpatch].fx[efmax-1][1]!=0)
    return;
  for(var j=efmax-1;j>currenteffect;--j){
    for(var k=0;k<11;++k){
      SetParamVal(currentpatch,j,k,GetParamVal(currentpatch,j-1,k));
    }
  }
  SetParamVal(currentpatch,currenteffect,0,1);
  for(var k=1;k<11;++k)
    SetParamVal(currentpatch,currenteffect,k,0);
  DispPatch();
  DispPatchName(currentpatch);
  SetCurrentEffect(currenteffect);
  midiif.SendCurrentPatch();
  dirty=1;
  PopupEffectCancel();
}
function PopupEffectUp(){
  if(currenteffect>0){
    var e=GetEffect(currentpatch,currenteffect);
    SetEffect(currentpatch,currenteffect,GetEffect(currentpatch,currenteffect-1));
    SetEffect(currentpatch,currenteffect-1,e);
    DispPatchName(currentpatch);
    midiif.SendCurrentPatch();
    dirty=1;
  }
  PopupEffectCancel();
}
function PopupEffectDown(){
  if(currenteffect<5){
    var e=GetEffect(currentpatch,currenteffect);
    SetEffect(currentpatch,currenteffect,GetEffect(currentpatch,currenteffect+1));
    SetEffect(currentpatch,currenteffect+1,e);
    DispPatchName(currentpatch);
    midiif.SendCurrentPatch();
    dirty=1;
  }
  PopupEffectCancel();
}
function PopupPatchMenu2(tar){
  var rc=tar.getBoundingClientRect();
  var e=document.getElementById("popuppatch2");
  e.style.display="block";
  e.style.left=(rc.left-20+window.pageXOffset)+"px";
  e.style.top=(rc.top+20+window.pageYOffset)+"px";
}
function PopupPatchCancel2(){
  document.getElementById("popuppatch2").style.display="none";
}
function PopupPatchMenu(tar){
  var rc=tar.getBoundingClientRect();
  var e=document.getElementById("popuppatch");
  e.style.display="block";
  e.style.left=(rc.left-20+window.pageXOffset)+"px";
  e.style.top=(rc.top+20+window.pageYOffset)+"px";
}
function PopupPatchCancel(){
  var e=document.getElementById("popuppatch");
  e.style.display="none";
  if(dragtarget){
    dragtarget=null;
  }
}
function PopupPatchOverwrite(){
  var t=(parseInt(dragtarget.id)-1);
  document.getElementById("popuppatch").style.display="none";
  clipboard.CopyFrom(patches[currentpatch]);
  SelectPatch(t);
  PopupPatchPaste(t);
  dragtarget=null;
}
function PopupPatchExchange(){
  var dst=parseInt(dragtarget.id)-1;
  clipboard.CopyFrom(patches[currentpatch]);
  patches[currentpatch].CopyFrom(patches[dst]);
  DispPatchName(currentpatch);
  SendPatch(currentpatch);
  PopupPatchPaste(dst);
  dragtarget=null;
  var e=document.getElementById("popuppatch");
  e.style.display="none";
}
function PopupPatchCopy(){
  clipboard.CopyFrom(patches[currentpatch]);
  PopupPatchCancel2();
}
function PopupPatchPaste(t){
  if(clipboard){
    if(typeof(t)=="undefined")
      t=currentpatch;
    patches[t].CopyFrom(clipboard);
    DispPatch();
    DispPatchName(t);
    if(t!=currentpatch)
      SelectPatch(t);
    midiif.Send(patches[currentpatch].MakeBin(midiif.devid));
    midiif.RequestPatch();
    if(autosave)
      StorePatch(t);
  }
  PopupPatchCancel2();
}
function PopupPatchDelete(){
  var tar=document.getElementById((currentpatch+1)+"nam");
  var rc=tar.getBoundingClientRect();
  var panel=document.getElementById("confirmpanel");
  Confirm("Delete patch ?",function(ev){
    for(var i=0;i<6;++i){
      for(var j=0;j<11;++j){
        patches[currentpatch].fx[i][j]=0;
      }
    }
    patches[currentpatch].maxfx=1;
    patches[currentpatch].curfx=0;
    patches[currentpatch].name="Empty";
    midiif.Send(patches[currentpatch].MakeBin(midiif.devid));
    midiif.RequestPatch();
    DispPatchName(currentpatch);
    DispPatch();
    if(autosave)
      StorePatch(currentpatch);
    ev.target.parentNode.parentNode.style.display="none";
  },
  {x:(rc.left-100+window.pageXOffset), y:(rc.top+24+window.pageYOffset)},
  );
  PopupPatchCancel2();
}
function PopupEdit(f,p,par){
  var tar=document.getElementById("f"+f+"p"+p+"v");
  var rc=tar.getBoundingClientRect();
  var offs;
  var panel=document.getElementById("popupeditpanel");
  var top=(377+(f-1)*42);
  var left=190+(p-1)*96;
  if(f>=5) top-=115;
  panel.onclick=(ev)=>{
    ev.stopPropagation();
  }
  switch(typeof(par.disp)){
  case "object": 
    if(typeof(par.disp.min)=="undefined"){
      var s=`<div style='height:${par.disp.length*20}px'>`;
      for(let i=0;i<par.disp.length;++i){
        s+=`<button>${par.disp[i]}</button><br/>`;
      }
      s+="</div>";
      panel.innerHTML=s;
      panel.style.left=left+"px";
      panel.style.top=top+"px";
      panel.style.display="block";
      for(let i=0;i<par.disp.length;++i){
        var e=panel.childNodes[0].childNodes[i*2];
        e.onclick=()=>{
          SetParamVal(currentpatch,f-1,p+1,i);
          DispPatch(currentpatch);
          panel.style.display="none";
        };
      }
    }
    else{
      var s=`<div style='height:${par.disp.list.length*20}px'><div>Range : ${par.disp.min} .. ${par.disp.max-1}</div><input value="${GetParamVal(currentpatch,f-1,p+1)+par.disp.min}" style="margin-bottom:4px"/><br/>`;
      for(let i=0;i<par.disp.list.length;++i){
        s+=`<button>${par.disp.list[i]}</button><br/>`;
      }
      s+="</div>";
      panel.innerHTML=s;
      panel.style.left=left+"px";
      panel.style.top=top+"px";
      panel.style.display="block";
      for(let i=0;i<par.disp.list.length;++i){
        var e=panel.childNodes[0].childNodes[(i+1)*2+1];
        e.onclick=()=>{
          console.log(par.disp.max+i)
          SetParamVal(currentpatch,f-1,p+1,par.disp.max+i-par.disp.min);
          DispPatch(currentpatch);
          panel.style.display="none";
        };
      }
      var input=panel.childNodes[0].childNodes[1];
      input.focus();
      input.selectionStart=input.selectionEnd=100;
      input.onkeydown=(ev)=>{
        console.log(ev.key);
        switch(ev.key){
        case "Enter":
          var val=input.value;
          if(val<par.disp.min) val=par.disp.min;
          if(val>=par.max+par.disp.min) val=par.max+par.disp.min;
          val-=par.disp.min;
          if(isNaN(val)) val=0;
          SetParamVal(currentpatch,f-1,p+1,val);
          panel.style.display="none";
          DispPatch(currentpatch);
          break;
        case "Escape":
          panel.style.display="none";
          break;
        }
      }
    }
    return;
  case "undefined": offs=0; break;
  case "number": offs=par.disp; break;
  }
  panel.innerHTML=`<div>Range : ${offs} .. ${offs+par.max}</div><input value="${GetParamVal(currentpatch,f-1,p+1)+offs}"/>`;
  panel.style.top=top+"px";
  panel.style.left=left+"px";
  panel.style.display="block";
  PopupPatchCancel2();
  var input=panel.childNodes[1];
  input.focus();
  input.selectionStart=input.selectionEnd=100;
  input.onkeydown=(ev)=>{
    console.log(ev.key);
    switch(ev.key){
    case "Enter":
      var val=input.value;
      if(val<offs) val=offs;
      if(val>=par.max+offs) val=par.max+offs;
      val-=offs;
      if(isNaN(val)) val=0;
      SetParamVal(currentpatch,f-1,p+1,val);
      panel.style.display="none";
      DispPatch(currentpatch);
      break;
    case "Escape":
      panel.style.display="none";
      break;
    }
  }
  input.onblur=()=>{
    panel.style.display="none";
  };
}
function PopupPatchRename(){
  document.getElementById("inputtext").value=patches[currentpatch].name;
  var tar=document.getElementById((currentpatch+1)+"nam");
  document.getElementById("inputmsg").innerHTML="Rename Patch";
  var rc=tar.getBoundingClientRect();
  document.getElementById("inputbase").style.display="block";
  var panel=document.getElementById("inputpanel");
  panel.style.left=(rc.left-120+window.pageXOffset)+"px";
  panel.style.top=(rc.top+20+window.pageYOffset)+"px";
  document.getElementById("inputtext").focus();
  PopupPatchCancel2();
  document.getElementById("inputok").onclick=function(ev){
    var i;
    var name=document.getElementById("inputtext").value;
    var p=currentpatch;
    patches[p].name=name.substr(0,10);
    DispPatchName(p);
    midiif.SendCurrentPatch();
    if(autosave)
      StorePatch(currentpatch);
    document.getElementById("inputbase").style.display="none";
  };
}
function SelectPort(){
  if(midioutputs.length>0){
    midiif.midiout=midioutputs[document.getElementById("midiport").selectedIndex];
    if(midiif.midiout && midiif.midiout.name!="ZOOM MS Series")
      midiif.midiout=null;
  }
}
function GetEffectId(p,n){
  return GetParamVal(p,n,1);
}
function GetDspState(p,n){
  if(midiif.devid==0x5f){
    return (patches[p].data[88]>>n)&1;
  }
  else{
    return (patches[p].data[129]>>n)&1;
  }
}
function GetParamVal(p,n,param){
  var pat=patches[p];
  if(!pat)
    return 0;
  return pat.fx[n][param];
}
function SetParamVal(p,n,param,val){
  var pat=patches[p];
  if(!pat)
    return 0;
  pat.fx[n][param]=val;
}
function GetCurrentEffect(){
  var pat=patches[currentpatch];
  if(!pat)
    return 0;
  var len=pat.data.length;
  if(len>=146)
    return 6-(((pat.data[130]&1)<<2)+((pat.data[125]&8)>>2)+((pat.data[129]&0x40)>>6));
  else
    return 3-(((pat.data[88]&0x40)>>6)+((pat.data[85]&0x10)>>3));
}
function SetCurrentEffect(n){
  var pat=patches[currentpatch];
  if(!pat)
    return 0;
  pat.curfx=n;
}
function GetEffectMax(){
  var pat=patches[currentpatch];
  if(!pat)
    return 0;
  if(pat.length<146)
    return (pat.data[89]&0x1c)>>2;
  return (pat.data[130]&0x1c)>>2;
}
function SetEffectMax(n){
  var pat=patches[currentpatch];
  if(!pat)
    return 0;
  if(pat.length<146)
    pat.data[89]=(pat.data[89]&~0x1c)+((n<<2)&0x1c);
  else
    pat.data[130]=(pat.data[130]&~0x1c)+((n<<2)&0x1c);
}
function GetEffectFromId(id){
  var ef=[];
  if(!effectlist[id])
    id=0;
  var e=effectlist[id];
  id=parseInt(id);
  ef.push(1);
  ef.push(id);
  for(var i=0;i<e.param.length;++i)
    ef.push(e.param[i].def);
  for(;i<9;++i)
    ef.push(0);
  return ef;
}
function GetEffect(p,n){
  var ef=[];
  for(var i=0;i<11;++i)
    ef.push(GetParamVal(p,n,i));
  return ef;
}
function SetEffect(p,n,ef){
  for(var i=0;i<11;++i){
    SetParamVal(p,n,i,ef[i]);
  }
  DispPatch();
}
function GetEffectParams(p,n){
  var r=[];
  for(var i=0;i<9;++i)
    r.push(GetParamVal(p,n,i));
  return r;
}
function GetEffectState(p,n){
  return GetParamVal(p,n,0);
}
function SetEffectState(p,n,on){
  SetParamVal(p,n,0,on?1:0);
  if(p==currentpatch){
    var id=GetEffectId(p,n);
    if(midiif.dump==3)
      console.log("effectid:"+id.toString(16));
    var ef=effectlist[id];
    var c=document.getElementById("fnam"+(n+1));
    if(ef && id!=0 && on)
      c.classList.add("press");
    else
      c.classList.remove("press");
  }
}
function ToggleEffect(n){
  SetEffectState(currentpatch, n,GetEffectState(currentpatch,n)^1);
  midiif.SendCurrentPatch();
}
function DispPatchName(p){
  document.getElementById((p+1)+"nam").innerHTML=patches[p].name;
  for(var i=0;i<6;++i){
    var id=patches[p].GetEffectId(i);
    var on=patches[p].GetEffectState(i);
    var icon=document.getElementById((p+1)+"_"+(i+1));
    if(midiif.devid==0x5f &&i>=4){
      icon.style.display="none";
    }
    else{
      icon.style.display="block";
    }
    if(id)
      icon.classList.add("exist");
    else
      icon.classList.remove("exist");
    if(on)
      icon.classList.add("on");
    else
      icon.classList.remove("on");
  }
}
function DispPatch(patch){
  var efmax,n,p,cell;
  var dspgraph=document.getElementById("dspgraph");
  var tab=document.getElementById("effects");
  if(typeof(patch)=="undefined")
    patch=currentpatch;
  efmax=(midiif.devid==0x5f)?4:6;
  dspgraph.style.height=57*efmax+"px";
  var dspsum=0;
  for(n=0;n<efmax;++n){
    var id=patches[patch].GetEffectId(n);
    var ef=effectlist[id];
    if(!ef)
      id=0,ef=effectlist[0];
    var b=dspgraph.childNodes[n];
//    b.style.height=(ef.dspmax+ef.dspmin)*50+"%";
    b.style.height=(1/ef.dsp)*100+"%";
    b.style.background=ef.col;
    var c=document.getElementById("fnam"+(n+1));
    var t=document.getElementById("ftxt"+(n+1));
    var img=document.getElementById("fimg"+(n+1));
    var full=document.getElementById("full"+(n+1));
    full.src=patches[patch].GetDspState(n)?"./images/dspfull.png":"./images/THRU.png";
    if(ef){
      full.title=ef.title;
      img.src="./images/"+ef.name.replace(/ /g,"_")+".png";
      if(ef.name=="THRU")
        c.classList.add("thru");
      else
        c.classList.remove("thru");
      t.innerHTML=ef.name;
    }
    else{
      full.title="";
      img.src="";
      t.innerHTML="unknown";
    }
    if(ef && id!=0 && patches[patch].GetEffectState(n))
      c.classList.add("press");
    else
      c.classList.remove("press");
    if(ef){
      for(p=0;p<9;++p){
        cell=tab.rows[n].cells[p+1];
        var s="f"+(n+1)+"p"+(p+1);
        var el=document.getElementById(s+"l");
        var ek=document.getElementById(s+"k");
        var es=document.getElementById(s+"s");
        var ev=document.getElementById(s+"v");
        if(p<ef.param.length){
          el.innerHTML=ef.param[p].name;
          ev.style.display="flex";
          if(ef.param[p].max==1){
            es.style.display="block";
            ek.style.display="none";
          }
          else{
            es.style.display="none";
            ek.style.display="flex";
          }
          var v=patches[patch].GetParamVal(n,p+2);
          if(typeof(ef.param[p].max)=="object"){
            for(var k=ef.param[p].max.length-1;k>=0;--k){
              if(ef.param[p].max[k]==v){
                v=k;
                break;
              }
            }
          }
          var ds=ef.param[p].disp;
          switch(typeof(ds)){
          case "number":
            var dr=ef.param[p].dispr;
            if(dr>0){
              if(dr<1){
                ev.innerHTML=(v*dr+ds).toFixed(1);
              }
              else
                ev.innerHTML=v*dr+ds;
            }
            else
              ev.innerHTML=v+ds;
            break;
          case "object":
            if(ds.type=="Time"){
              const t=v+ds.min;
              if(t>=ds.max){
                ev.innerHTML=ds.list[t-ds.max];
              }
              else
                ev.innerHTML=t;
            }
            else
              ev.innerHTML=ds[v];
            break;
          default:
            ev.innerHTML=v;
          }
          if(typeof(ef.param[p].max)=="object"){
              ek.max=ef.param[p].max.length-1;
              ek.tab=ef.param[p].max;
              ek.setValue(v);
          }
          else{
            ek.max=ef.param[p].max;
            ek.tab=null;
            ek.defvalue=ef.param[p].def;
            es.defvalue=ef.param[p].def;
            if(ek.setValue)
              ek.setValue(v);
            if(es.setValue)
              es.setValue(v);
          }
        }
        else{
          el.innerHTML="";
          ek.style.display="none";
          ev.style.display="none";
          es.style.display="none";
        }
      }
    }
  }
}
function SelectPatch(p){
  p=parseInt(p);
  if(p<0)
    return;
  if(p==currentpatch)
    return;
  midiif.Send([0xc0,p]);
  SetPatchFocus(0);
  currentpatch=p;
  SetPatchFocus(1);
  DispPatch();
}
function SetPatchFocus(f){
  if(currentpatch<0)
    return;
  c=document.getElementById((currentpatch+1)+"nam");
  if(f)
    c.classList.add("sel");
  else
    c.classList.remove("sel");
}
function SendPatch(p){
  p=parseInt(p);
  midiif.Send(patches[p].MakeBin(midiif.devid));
}
function StorePatch(p,callback){
  console.log("store:"+p);
  var cmd=[0xf0,0x52,0x00,midiif.devid,0x32,0x01,0x00,0x00,0x2c,0x00,0x00,0x00,0x00,0x00,0xf7];
  cmd[8]=p;
  if(callback){
    midiif.SendWait(cmd,midiif.sysexhead+"00",callback);
  }
  else
    midiif.Send(cmd);
}
function InstallChecker(){
  this.list=[];
  this.n=0;
  this.norg=0;
  this.porg=new apatch();
  this.Start=function(){
    this.norg=currentpatch;
    this.porg.CopyFrom(patches[49]);
    SelectPatch(49);
    this.n=0;
    for(var id in effectlist){
      if(effectlist[id].install==0){
        effectlist[id].install=-1;
        document.getElementById("e_"+id).classList.add("notinstall");
        this.list.push(parseInt(id));
      }
    }
    if(this.list.length>0){
      document.getElementById("waitmsg").innerHTML="";
      document.getElementById("waitbase").style.display="block";
    }
  };
  this.timer=function(){
    if(this.list.length<=0)
      return;
    document.getElementById("waitmsg").innerHTML="Effect Install Check...("+this.list.length+")";
    while(this.n<4&&this.list.length>0){
      SetEffect(currentpatch,this.n,GetEffectFromId(this.list.shift()));
      ++this.n;
    }
    this.n=0;
    midiif.Send(patches[currentpatch].MakeBin(midiif.devid));
    midiif.Send([0xf0,0x52,0,midiif.devid,0x29,0xf7]);
    if(this.list.length<=0){
      setTimeout(function(){
        midiif.Send(this.porg.MakeBin(midiif.devid));
        patches[49].CopyFrom(this.porg);
        DispPatchName(currentpatch);
        DispPatch();
        SelectPatch(currentpatch);
        document.getElementById("waitbase").style.display="none";
      }.bind(this),700);
    }
  };
  this.ShowAll=function(f){
    for(id in effectlist){
      var el=document.getElementById("e_"+id);
      if(el){
        if(f)
          el.style.display="inline-block";
        else{
          var ef=effectlist[id];
          if(ef.install>=-1)
            el.style.display="inline-block";
          else
            el.style.display="none";
        }
      }
    }
  };
  setInterval(this.timer.bind(this),500);
}
function InstallCheck(){
  document.getElementById("effectpanelmsg").innerHTML="Install Check";
  document.getElementById("effectpanelbase").style.display="block";
  inst.Start();
}
function SavePatchToDevice(){
  StorePatch(currentpatch,function(){});
}
function SaveAllToDevice(){
  var saver=new StoreAll();
}
function AutoSave(){
  var btn=document.getElementById("autosavebtn");
  if(btn){
    if(btn.style.background==""){
        btn.style.background="linear-gradient(#c33,#b22)";
        btn.style.color="#fff";
        document.getElementById("devsavebtn").disabled=true;
        autosave=1;
    }
    else{
      btn.style.background="";
      btn.style.color="#fff";
      document.getElementById("devsavebtn").disabled=false;
      autosave=0;
    }
    document.cookie="autosave="+autosave;
  }
}
function Tuner(){
  var btn=document.getElementById("tunerbtn");
  if(btn.style.background==""){
      btn.style.background="linear-gradient(#c33,#b22)";
      btn.style.color="#fff";
      midiif.Send([0xb0,0x4a,0x7f]);
  }
  else{
    btn.style.background="";
    btn.style.color="#fff";
    midiif.Send([0xb0,0x4a,0x00]);
  }
}
function Usage(){
  var e=document.getElementById("usagebase");
  if(e.style.display!="block"){
    e.style.display="block";
  }
  else{
    e.style.display="none";
  }
}
function SaveBank(){
  var p;
  var zip=new JSZip();
  for(p=0;p<50;++p){
    var s=MakeStr(patches[p].MakeBin(midiif.devid))+"\r\n";
    var n=("0"+(p+1)).substr(-2)+"@"+(patches[p].name.replace(/ +/g,"").replace(/ /g,"_"))+"."+midiif.devstr;
    zip.file(n,s);
  }
  zip.generateAsync({type:"blob"}).then(function (blob) {
    var a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.target="_blank";
    a.download="newbank."+midiif.devstr+".zip";
    a.click();
  });
}
function StoreAll(callback){
  document.getElementById("waitmsg").innerHTML="Storing...";
  document.getElementById("waitbase").style.display="block";
  this.res=[];
  this.cnt=0;
  this.ready=0;
  this.cb=callback;
  this.Next=function(){
    if(this.cnt>=50){
      document.getElementById("waitbase").style.display="none";
      this.ready=1;
      if(this.cb)
        this.cb();
      return;
    }
    document.getElementById("waitmsg").innerHTML="Storing...("+this.cnt+"/50)";
    midiif.SendDirect([0xc0,this.cnt]);
    midiif.SendDirect(patches[this.cnt].MakeBin(midiif.devid));
    StorePatch(this.cnt++,this.Next.bind(this));
  };
  this.Next();
}
function LoadBank(){
  var i=document.createElement("input");
  i.type="file";
  i.click();
  i.addEventListener("change",function(ev){
    var file=ev.target.files;
    var reader=new FileReader();
    var zip=new JSZip();
    var cnt=0;
    if(file[0].name.substr(-4)==".zip"){
      reader.onload=function(ev){
        zip.loadAsync(reader.result).then(
          function(zip){
            console.log("loadbank");
            Confirm("Overwrite all patches, Sure?",
              function(ev){
                ev.target.parentNode.parentNode.style.display="none";
                zip.forEach(function(name,c){
                  zip.file(name).async("string").then(function(txt){
                    var n=parseInt(name.substr(0,2))-1;
                    var bin=MakeBin(txt,146);
                    patches[n].ReadBin(bin);
                    if(bin[3]!=midiif.devid){
                      AlertMsg("This patch is not for "+midiif.devstr);
                      return;
                    }
                    DispPatchName(n);
                    if(autosave){
                      if(++cnt>=50){
                        new StoreAll(function(){
                          document.getElementById("waitbase").style.display="none";
                        });
                      }
                    }
                  });
                });
              }
            );
          }
        )
      };
      reader.readAsArrayBuffer(file[0]);
    }
    else{
      reader.readAsText(file[0]);
      reader.onload=function(ev){
        if(reader.result.indexOf("1:f052005828")!=0){
          AlertMsg("Bank file error");
          return;
        }
        var s=reader.result.split("\n");
        for(var i=0;i<50;++i){
          s[i]=s[i].split(":");
          patches[i].ReadBin(MakeBin(s[i][1],146));
          DispPatchName(i);
        }
        if(autosave){
          new StoreAll(function(){
            document.getElementById("waitbase").style.display="none";
          });
        }
      }
    }
  },false);
}
function ShowPatch(){
  var p=currentpatch;
  if(p<0)
    return;
  var n=patches[p].name;
  var fname=n.replace(/\s+$/,"").replace(/ /g,"_");
  var d=MakeStr(patches[p].MakeBin(midiif.devid));
  AlertMsg("Show Patch As Text <br/><textarea disabled style='width:360px;height:100px'>"+d+"</textarea>");
}
function ExportPatch(){
  var p=currentpatch;
  if(p<0)
    return;
  var n=patches[p].name;
  var fname=n.replace(/\s+$/,"").replace(/ /g,"_");
  var d=MakeStr(patches[p].MakeBin(midiif.devid));
  var blob=new Blob([d],{"type":"text/plain"});
  var a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.target="_blank";
  a.download=fname+"."+midiif.devstr;
  a.click();
}
function ReadPatch(data){
  if(data[3]!=midiif.devid){
    Confirm("This patch is not for MS-"+midiif.devstr+".<br/> Load anyway ?",function(ev){
      data[3]=midiif.devid;
      ev.target.parentNode.parentNode.style.display="none";
      ReadPatch(data);
    });
    return;
  }
  patches[currentpatch].ReadBin(data);
  DispPatchName(currentpatch);
  DispPatch(currentpatch);
  SelectPatch(currentpatch);
  midiif.SendCurrentPatchVerify(function(s){
    if(s)
      AlertMsg("Following effect(s) are not exist<br/>"+s);
    console.log(s);
  });
  if(autosave)
    StorePatch(currentpatch);
}
function ImportPatch(){
  var p=currentpatch;
  if(p<0)
    return;
  var i=document.createElement("input");
  i.type="file";
  i.click();
  i.addEventListener("change",function(ev){
    var file=ev.target.files;
    if(file[0].name.substr(-4)==".zip"){
      document.getElementById("patchenum").style.display="block";
      var reader=new FileReader();
      var zip=new JSZip();
      var cnt=0;
      reader.onload=function(ev){
        zip.loadAsync(reader.result).then(
          function(zip){
            for(var i=0;i<50;++i)
              document.getElementById("patchenumlist").rows[i%10].cells[(i/10)|0].innerHTML="";
            zip.forEach(function(name,c){
              zip.file(name).async("string").then(function(txt){
                var n=parseInt(name.substr(0,2))-1;
                var e=document.createElement("button");
                e.setAttribute("class","patchbtn");
                e.data=MakeBin(txt,146);
                name=name.replace(/.50g$/,"").replace(/.60b$/,"").replace(/.70cdr$/,"");
                e.innerHTML=name;
                document.getElementById("patchenumlist").rows[n%10].cells[(n/10)|0].appendChild(e);
                e.onclick=function(){
                  ReadPatch(this.data);
                  document.getElementById("patchenum").style.display="none";
                }
              });
            });
          }
        );
      };
      reader.readAsArrayBuffer(file[0]);
      return;
    }
    var reader=new FileReader();
    reader.readAsText(file[0]);
    reader.onload=function(ev){
      var data=MakeBin(reader.result,146);
      ReadPatch(data);
    }
  },false);
}
function ImportText(){
  var tar=document.getElementById((currentpatch+1)+"nam");
  var panel=document.getElementById("textareabase");
  document.getElementById("textareamsg").innerHTML="Load from Text : Paste here the Text from 'Show Patch as text'<br/> or guitarpatches.com's zoom MS-50G patch page texts.";
  document.getElementById("textareatext").value="";
  var rc=tar.getBoundingClientRect();
  panel.style.display="block";
  PopupPatchCancel2();
  document.getElementById("textareaok").onclick=function(ev){
    var str=document.getElementById("textareatext").value;
    var h=str.indexOf("f05200");
    if(h>=0){
      var str=str.substr(h);
      var data=MakeBin(str,146);
      console.log(data);
      var len=0;
      if(data[145]==0xf7) len=146;
      if(data[104]==0xf7) {
        len=105;
        data=slice(0,105);
      }
      console.log(data);
      if(len){
        ReadPatch(data);
        document.getElementById("textareabase").style.display="none";
        return;
      }
    }
    var tx=str.split("\n");
    var param=0;
    var id=0;
    var found=0;
    var name="";
    for(var l=0,m=tx.length;l<m;++l){
      if(tx[l].indexOf("Description")==0 && l>0){
        for(var ll=l-1;ll>=0&&ll>=l-2;--ll)
          if(tx[ll].length>0)
            name=tx[ll].substr(0,10);
      }
      if(tx[l].indexOf("EFFECT")==0){
        var n=parseInt(tx[l][7])-1;
        if(n>=0 && n<6){
          found=1;
          var enam=tx[l].split(":")[1].substr(1);
          if(enam=="OFF")
            enam="THRU";
          for(id in effectlist){
            if(effectlist[id].name==enam){
              SetEffect(currentpatch,n,GetEffectFromId(id));
              break;
            }
          }
        }
      }
      if(param>=2&&param<11){
        var v=parseInt(tx[l]);
        var pm=effectlist[id].param[param-2];
        if(pm){
          if(typeof(pm.disp)=="number"){
            v-=pm.disp;
          }
          else if(typeof(pm.disp)=="object"){
            for(v=0;v<pm.disp.length;++v){
              if(pm.disp[v].toLowerCase().indexOf(tx[l].toLowerCase())==0){
                break;
              }
            }
            if(v==pm.disp.length)
              v=0;
            if(typeof(pm.max)=="object")
              v=pm.max[v];
          }
          SetParamVal(currentpatch,n,param,v);
        }
        param=0;
      }
      if(tx[l].indexOf("Page")==0){
        var t=tx[l].split("-");
        param=parseInt(t[0].substr(4))*3+parseInt(t[1].substr(4))-2;
      }
    }
    if(found){
      patches[currentpatch].name=name;
      DispPatchName(currentpatch);
      DispPatch(currentpatch);
      SelectPatch(currentpatch);
      midiif.SendCurrentPatchVerify(function(s){
        if(s)
          AlertMsg("Following effect(s) are not exist<br/>"+s);
        console.log(s);
      });
      if(autosave)
        StorePatch(currentpatch);
    }
    else {
      AlertMsg("No patch data is found.");
    }
    document.getElementById("textareabase").style.display="none";
  };
}
function OpenUrl(url){
  window.open(url);
}
function ShowDoc(x) {
  var divs=document.getElementsByTagName("div");
  var t="doc_"+x;
  for(var i=0;i<divs.length;++i) {
    if(divs[i].className==="doc_ja")
      divs[i].style.display=(x==="ja")?"block":"none";
    if(divs[i].className=="doc_en")
      divs[i].style.display=(x==="ja")?"none":"block";
  }
}
function GetLang() {
  return (navigator.language || navigator.browserLanguage).substring(0, 2);
}
window.addEventListener("load",Init);

</script>
<style>
body{
  background:#000;
  margin:0px;
  padding:0px;
}
#base{
  position:absolute;
  user-select:none;
  top:0px;
  bottom:0px;
  left:0px;
  right:0px;
  font-family: 'Open Sans', sans-serif;
  font-size:14px;
  font-weight:bold;
  border-radius:5px;
  width:930px;
  height:600px;
  margin:auto;
  padding:1px 20px 40px 20px;
  background:url(./images/bgnew.jpg);
  border-right:3px solid #666;
  border-bottom:3px solid #666;
  border-left:3px solid #fff;
  border-top:3px solid #fff;
  box-shadow:3px 3px 3px 4px rgba(114, 95, 95, 0.3);
}
#info{
  font-size:10px;
  font-weight:normal;
  text-align: left;
}
h1{
  font-family: 'AudioWide',sans-serif;
  font-size:22px;
  margin:10px 0px 0px 0px;
}
#header{
  position:absolute;
  top:10px;
  left:20px;
  background:#036;
  color:#ddf;
  margin:0px;
  width:1100px;
  height:70px;
}
#g200kglogo{
  height:60px;
  position:absolute;
  top:5px;
  left:5px;
  cursor:pointer;
}
#title{
  position:absolute;
  top:0px;
  left:135px;
}
#subtitle{
  position:absolute;
  top:45px;
  left:135px;
}
#version{
  position:absolute;
  top:20px;
  left:340px;
}
#header .info{
  position: absolute;
  top:10px;
  right:0px;
  width:250px;
  margin-right:10px;
  margin-left:auto;
  font-size:8px;
}
#header a{
  color:#ccf;
}
.popup {
  font-family: 'Open Sans', sans-serif;
  font-weight: normal;
  font-size: 13px;
  position: absolute;
  display: none;
  width: 200px;
  background: linear-gradient(135deg, #9ebbe1, #4f6789);
  border: 1px solid #444;
  border-radius: 6px;
  list-style: none;
  margin: 0;
  padding: 5px 0;
  box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
  user-select: none;
  z-index: 1000;
  overflow: hidden; /* Prevents border-radius clipping */
}

/* Menu items */
.popup > li {
  background: transparent;
  margin: 0;
  padding: 0;
  transition: background 0.2s ease-in-out;
}

/* Links inside menu items */
.popup > li > a {
  display: block;
  text-decoration: none;
  color: #1b1c1e;
  padding: 4px 10px;
  cursor: pointer;
  transition: color 0.2s ease-in-out, background 0.2s ease-in-out;
  font-weight: bold;
  border-radius: 4px;
}

/* Hover effect */
.popup > li:hover {
  background: linear-gradient(135deg, #88aacc, #7799bb);
}

.popup > li > a:hover {
  color: #fff;
}

img{
  margin:0px;
  padding:0px;
}
.patch{
  background: #66f;
  border:1px solid #225;
  border-radius: 5px;
  width:220px;
  height:60px;
}
.menubtn {
  width: 120px;
  height: 46px;
  background: linear-gradient(135deg, #222, #444);
  color: #fff;
  font-size: 14px;
  font-weight: bold;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s ease-in-out;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
  text-transform: uppercase;
  align-items: center;
  justify-content: center;
}

.menubtn:hover {
  background: linear-gradient(135deg, #444, #666);
  transform: translateY(-2px);
  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
}

.menubtn:active {
  transform: translateY(1px);
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.menubtn[disabled]{
  color:#aaa;
}
#popupeditpanel{
  position:absolute;
  top:0;
  left:0;
  width:160px;
  height:50px;
  padding:10px;
  overflow-y:auto;
}
#popupeditpanel button {
  width:140px;
  height:20px;
}
.modalbase{
  position:absolute;
  display:none;
  left:0;
  top:0;
  width:100%;
  height:100%;
  background:rgba(0,0,0,0.2);
}
#alertpanel {
  font-family: 'Open Sans', sans-serif;
  font-weight: normal;
  font-size: 14px;
  position: fixed; /* Keep it centered on the screen */
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: linear-gradient(135deg, #3a3f50, #555f77); /* Matching dark gradient */
  border: 1px solid #444;
  border-radius: 6px;
  padding: 15px;
  box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
  color: antiquewhite;
  text-align: center;
  z-index: 1100;
}

/* Header for alert */
#alertpanel .alert-header {
  font-size: 16px;
  font-weight: bold;
  color: #ffd;
  margin-bottom: 10px;
}

/* Alert message text */
#alertpanel .alert-message {
  font-size: 13px;
  color: #ddd;
  margin-bottom: 15px;
}

/* Buttons inside Alert Panel */
#alertpanel button {
  text-transform: uppercase;
  width: 100px;
  background: linear-gradient(135deg, #446, #668);
  color: #ffd;
  font-size: 12px;
  font-weight: bold;
  border: 1px solid #444;
  border-radius: 4px;
  padding: 6px 12px;
  cursor: pointer;
  transition: background 0.2s ease-in-out;
  margin: 5px;
}

#alertpanel button:hover {
  background: linear-gradient(135deg, #668, #88a);
  color: #fff;
}

#alertmsg{
  display: table-cell;
  width: 360px;
  height: 100px;
  text-align: center;
}
#confirmpanel {
  font-family: 'Open Sans', sans-serif;
  font-weight: normal;
  font-size: 13px;
  position: absolute;
  /* width: 200px; */
  background: linear-gradient(135deg, #b8cbe4, #a4b8d4); /* Same gradient */
  border: 1px solid #666;
  border-radius: 6px;
  list-style: none;
  margin: 0;
  padding: 10px;
  box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
  user-select: none;
  z-index: 1000;
  overflow: hidden; /* Prevents border-radius clipping */
  text-align: center;
}

/* Button Styling Inside Confirmation Panel */
#confirmpanel button {
  text-transform: uppercase;
  background: linear-gradient(135deg, #446, #668);
  color: #ffd;
  font-size: 12px;
  font-weight: bold;
  border: 1px solid #444;
  border-radius: 4px;
  padding: 3px 10px;
  cursor: pointer;
  transition: background 0.2s ease-in-out;
}

#confirmpanel button:hover {
  background: linear-gradient(135deg, #668, #88a);
  color: #fff;
}

#confirmmsg {
  padding-bottom: 6px;
  font-weight: 600;
}
#inputpanel {
  position: fixed; /* Ensures it's centered and above other elements */
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 300px;
  height: auto;
  padding: 15px;
  font-family: 'Open Sans', sans-serif;
  font-size: 14px;
  background: linear-gradient(135deg, #3a3f50, #555f77); /* Dark modern gradient */
  color: antiquewhite;
  border: 1px solid #444;
  border-radius: 6px;
  box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
  text-align: center;
  z-index: 1100;
}

/* Buttons inside input panel */
#inputpanel button {
  text-transform: uppercase;
  width: 80px;
  margin: 8px;
  padding: 6px;
  background: linear-gradient(135deg, #446, #668);
  color: #ffd;
  font-size: 12px;
  font-weight: bold;
  border: 1px solid #444;
  border-radius: 4px;
  cursor: pointer;
  transition: background 0.2s ease-in-out;
}

#inputpanel button:hover {
  background: linear-gradient(135deg, #668, #88a);
  color: #fff;
}

/* Input field inside input panel */
#inputpanel input {
  width: 220px;
  padding: 5px;
  border: 1px solid #777;
  border-radius: 4px;
  font-size: 14px;
  text-align: center;
  background: #222;
  color: #ffd;
}

#inputmsg {
  padding-bottom: 7px;
}
#textareapanel{
  position:absolute;
  font-family:'Open Sans', sans-serif;
  font-weight:normal;
  font-size:14px;
  background:#cce;
  border: 1px solid #666;
  border-radius: 3px;
  box-shadow: 2px 2px 3px 3px rgba(0,0,0,0.4);
  width:800px;
  height:200px;
  padding:10px;
  margin:auto;
  left:0;
  right:0;
  top:0;
  bottom:0;
}
#textareapanel textarea{
  width:700px;
  height:100px;
  resize:none;
}
#textareapanel button{
  width:70px;
  margin:5px;
}
#mainmenu {
  position: absolute;
  width: 245px;
  left: 15px;
  top: 0px;
  border-radius: 8px;
  color: antiquewhite;
  font-family: serif;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
}
#mainmenu select {
  height: 25px;
  background: #333;
  color: antiquewhite;
  border: 1px solid #555;
  border-radius: 4px;
  padding: 2px 5px;
}

#mainmenu ul {
  padding: 0;
  list-style: none;
}

#mainmenu ul li {
  margin: 5px 0;
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

/* #mainmenu ul li div {
  display: inline-block;
} */

#mainmenu hr {
  border: 0;
  height: 1px;
  background: #666;
  margin: 8px 0;
  width: 100%;
}
/* Main patches container */
#patchesbase {
  position: absolute;
  left: 267px;
  top: 10px;
  width: 682px;
  background: linear-gradient(135deg, #2d3240, #454f67); /* Darker, modern gradient */
  border: 3px solid #666;
  border-radius: 8px;
  box-shadow: inset 2px 2px 8px rgba(0, 0, 0, 0.4), 4px 4px 10px rgba(0, 0, 0, 0.3);
  padding: 4px 4px;
  color: antiquewhite;
  font-family: "Segoe UI", sans-serif;
}

/* Patches table */
#patches {
  /* width: 100%; */
  /* border-collapse: collapse; */
  /* background: linear-gradient(135deg, #3a3f50, #555f77);  */
  /* color: #ddd; */
  border: none;

}

/* Table rows */
#patches tr {
  transition: background 0.2s ease-in-out;
}

/* Hover effect */
#patches td:hover {
  background: rgba(255, 255, 255, 0.1);
}

/* Table cells */
#patches td {
  text-align: left;
  min-width: 40px;
  /* padding: 2px; */
  border: none;
  position: relative;

}

/* Side column for numbering */
#patches td.side-column {
  background: linear-gradient(135deg, #5a1212, #8a1c1c);
  color: white;
  font-weight: bold;
  text-align: center;
  border-right: 2px solid #aaa;
}

/* Patch Number Buttons */
.patch-number {
  background: linear-gradient(135deg, #222, #444);
  color: #ddd;
  font-size: 12px;
  font-weight: bold;
  border: 1px solid #666;
  border-radius: 4px;
  padding: 3px 6px;
  box-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
  text-align: center;
  cursor: pointer;
}

/* Button hover effect */
.patch-number:hover {
  background: linear-gradient(135deg, #444, #666);
  transform: scale(1.1);
}

/* Patch buttons inside table */
#patches button {
  width: 35px;
  height: 22px;
  background: linear-gradient(135deg, #222, #444);
  color: #fff;
  font-size: 12px;
  font-weight: bold;
  border: 1px solid #666;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s ease-in-out;
  box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
}

#patches button:hover {
  background: linear-gradient(135deg, #444, #666);
  transform: scale(1.1);
}

#patches button:active {
  transform: scale(0.95);
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
}

.pnam{
  display:inline-block;
  margin:0;
  padding:0;
  padding:1px 3px 1px 8px;
  border:1px solid #8ab;
  background: linear-gradient(#b4c4e4, #95a2bb);
  color:#124;
  height:20px;
  width:97px;
  font-size:14px;
  line-height: 14px;
  vertical-align: middle;
  font-weight: bold;
  box-sizing:border-box
}
.eficon{
  border:none;
  width:3px;
  padding:0px;
  height:4px;
  background:#668;
  position:absolute;
  bottom:1px
}
.eficon.exist{
  background:#c33;
}
.eficon.exist.on{
  background:#faa;
}
#patches div:hover{
  background:linear-gradient(#cde,#bcd);
}
#patches div.sel{
  background:linear-gradient(#c33,#b22);
  color:#fff;
}
#patches div.over{
  border: 2px dotted #44c;
}
#patches div.drag{
  opacity: 0.5;
}
#dspgraph{
  position:absolute;
  left:2px;
  top:295px;
  width:7px;
  height:0px;
  display:inline-block;
  background:#000;
  border:1px solid #000;
  overflow:hidden;
}
#dspgraph div{
  border-bottom:1px solid #000;
  background:#c00;
  box-sizing: border-box;
}
#effects{
  position:absolute;
  top:295px;
  left:10px;
  border-collapse:collapse;
  border-spacing:0px;
  box-shadow:1px 1px 1px 1px rgba(0,0,0,0.3);
}
#effects th {
  width:22px;
}
#effects td {
  width:83px;
  height:32px;
  border:1px solid #888;
  cursor:default;
  background:url(./images/bg-grad.png);
}
#effects td div div .param {
  align-items: center;  /* Center vertically */
  display: none;
  justify-content: center;  /* Center horizontally */
  background: #446;
  color: #ffd;
  width: 40px;
  height: 20px;
  margin: 0 auto;  /* Center horizontally inside parent */
  text-align: center;
  font-size: 12px;
  font-weight: normal;
  border-radius: 5px;
  margin-top: 10px;
}

#effects .fimg{
  position:absolute;
  left:0px;
  top:-2px;
  width:52px;
  height:52px;
  margin:-5px 0px 0px -2px;
  float:left;
  border:none;
}


#effects .fimg:not([src]), 
#effects .fimg[src=""] {
    display: none; /* Completely hides the empty image */
}


#effects .fnam{
  text-align: center;
  background:linear-gradient(#822,#400);
  color:#fcc;
  width:120px;
  box-sizing:border-box;
  vertical-align:middle;
  position:relative;
  text-align: center;
}
#effects .fnam:hover{
  background:linear-gradient(#a44,#622);
}
#effects .ftxt{
  display:inline;
  position:absolute;
  bottom:4px;
  right:4px;
}
#effects .fnam.drag{
  opacity: 0.5;
}
#effects .fnam.overup{
  border-top: 4px solid #fff;
}
#effects .fnam.overdown{
  border-bottom: 4px solid #fff;
}
#effects .fnam.press{
  background:linear-gradient(#b00 0%,#d77 25%,#d00 50%,#b00 100%);
  color:#fff;
}
#effects .fnam.press:hover{
  background:linear-gradient(#d22 0%,#f99 25%,#f22 50%,#d22 100%);
  color:#fff;
}
#effects .fnam.thru{
  background:linear-gradient(#706868,#403838);
}
#effects .fnam.thru .ftxt{
  color:#a09898;
}
.fnum {
    height: 54px;
    width: 53px;
    top: 1px;
    width: 54px;
    background: linear-gradient(135deg, #222, #444);
    color: #fff;
    font-size: 12px;
    font-weight: bold;
    border: 1px solid #666;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2sease-in-out;
    box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
}

.pcell{
  display:flex;
  font-size:12px;
  font-weight:bold;
  height:53px;
  border:none;
  padding:0;
  margin:0;
  box-sizing: border-box;
}
.pfocus{
  border:1px solid #c88;
}
input{
  width:45%;
}
webaudio-knob{
  display:none;
/*  width:32px;*/
  margin:4px 2px 0px 2px;
  top: 4px;
}
webaudio-switch{
  display:none;
/*  width:32px;*/
  top: 4px;
}
#effectpanel {
  position: fixed; /* Ensures it stays in place even when scrolling */
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%); /* Moves it back by half its width/height */
  font-family: 'Open Sans', sans-serif;
  font-weight: normal;
  font-size: 13px;
  position: absolute;
  width: 900px;
  background: linear-gradient(135deg, #3a3f50, #555f77); /* Dark gradient for a polished look */
  border: 1px solid #444;
  border-radius: 6px;
  list-style: none;
  margin: 0;
  padding: 10px;
  box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
  user-select: none;
  z-index: 1000;
  overflow: hidden; /* Prevents border-radius clipping */
}

/* Header for Effect Panel */
#effectpanel .panel-header {
  font-size: 14px;
  font-weight: bold;
  color: #ffd;
  text-align: center;
  padding: 8px 0;
  border-bottom: 1px solid rgba(255, 255, 255, 0.2);
}

/* List items inside panel */
#effectpanel ul {
  padding: 0;
  margin: 0;
  list-style: none;
}

#effectpanel li {
  padding: 6px 12px;
  cursor: pointer;
  transition: background 0.2s ease-in-out;
  color: #ddd;
  border-radius: 4px;
}

#effectpanel li:hover {
  background: linear-gradient(135deg, #668, #88a);
  color: #fff;
}

/* Buttons inside Effect Panel */
#effectpanel button {
  width: 100%;
  background: linear-gradient(135deg, #446, #668);
  color: #ffd;
  font-size: 12px;
  font-weight: bold;
  border: 1px solid #444;
  border-radius: 4px;
  cursor: pointer;
  transition: background 0.2s ease-in-out;
  margin-top: 10px;
}

#effectpanel button:hover {
  background: linear-gradient(135deg, #668, #88a);
  color: #fff;
}

#effectpanelscr{
  width:1010px;
  height:520px;
  margin:4px auto;
  overflow-y:scroll;
  background:#888;
  color:#fff;
}
#effectpanellist{
  width:850px;
}
.efgrp{
  width:850px;
  padding:4px 0px;
  border-bottom:1px solid #000;
}
.efitem{
  display:inline-block;
  position:relative;
  border-radius: 3px;
  border:1px solid #668;
  width:80px;
  height:84px;
  padding:0px;
  margin:1px;
  font-size:11px;
  font-weight: normal;
  color:#000;
  cursor:pointer;
  background:linear-gradient(#dde,#bbc);
}
.notinstall{
  background:linear-gradient(#c99,#b88);
}
.install{
  background:linear-gradient(#cfc,#ada);
}
.notinstall:hover{
  background:linear-gradient(#fdd,#ecc);
}
.install:hover{
  background:linear-gradient(#dfd,#cec);
}
.efitem img{
  display:block;
  width:64px;
  height:52px;
  margin:0px auto;
}
.efitem div{
  text-align: center;
}
.efitem div{
  padding:0px 4px;
}
.efitem .mk50{
  position:absolute;
  left:1px;
  bottom:0;
  height:13px;
  width:25px;
}
.efitem .mk60{
  position:absolute;
  left:27px;
  bottom:0;
  height:14px;
  width:25px;
}
.efitem .mk70{
  position:absolute;
  left:53px;
  bottom:0;
  height:14px;
  width:25px;
}
.efitem .dspbar{
  position:absolute;
  left:5px;
  bottom:30px;
  height:30px;
  width:4px;
  background:#f00;
  border:1px solid #000;
  padding:0;
  margin:0;
}
#usagepanel {
  position: fixed; /* Keeps it centered and above other elements */
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 900px;
  max-width: 90%;
  height: 500px;
  max-height: 80vh; /* Ensures it fits within the viewport */
  margin: auto;
  padding: 15px;
  transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
  overflow: hidden;
  font-size: 14px;
  font-weight: normal;
  border: 2px solid #334;
  border-radius: 8px;
  color: antiquewhite;
  background: linear-gradient(135deg, #3a3f50, #555f77);
  box-shadow: 6px 6px 15px rgba(0, 0, 0, 0.5);
  z-index: 1100;
}

/* Usage panel scrollbar */
#usagescr {
  width: 90%;
  height: 420px;
  padding: 10px;
  margin: 10px auto;
  overflow-y: auto; /* Keeps scroll functional */
  background: rgba(255, 255, 255, 0.05);
  border-radius: 5px;
}

/* Custom scrollbar styling */
#usagescr::-webkit-scrollbar {
  width: 8px;
}

#usagescr::-webkit-scrollbar-thumb {
  background: #668;
  border-radius: 4px;
}

#usagescr::-webkit-scrollbar-thumb:hover {
  background: #88a;
}

/* Modal fade-in animation */
#usagepanel.hidden {
  opacity: 0;
  transform: translate(-50%, -55%);
  pointer-events: none;
}


/* Patch buttons inside table */
#usagepanel button {
  text-transform: uppercase;
  width: 65px;
  height: 22px;
  background: linear-gradient(135deg, #222, #444);
  color: #fff;
  font-size: 12px;
  font-weight: bold;
  border: 1px solid #666;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s ease-in-out;
  box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
}

#waitpanel {
  text-transform: uppercase;
  font-family: 'Open Sans', sans-serif;
  font-weight: normal;
  font-size: 14px;
  position: fixed; /* Keep it centered on the screen */
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 250px;
  background: linear-gradient(135deg, #3a3f50, #555f77); /* Dark theme */
  border: 1px solid #444;
  border-radius: 6px;
  padding: 15px;
  box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
  color: antiquewhite;
  text-align: center;
  z-index: 1200;
}

/* Wait message text */
#waitpanel .wait-message {
  font-size: 13px;
  color: #ddd;
  margin-bottom: 10px;
}

/* Loading spinner */
#waitpanel .spinner {
  width: 24px;
  height: 24px;
  border: 3px solid rgba(255, 255, 255, 0.3);
  border-top: 3px solid #ffd;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  display: inline-block;
  margin-top: 10px;
}

/* Spinner animation */
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

#patchenumpanel{
  position:absolute;
  top:0;
  bottom:0;
  right:0;
  left:0;
  margin:auto;
  width:700px;
  height:350px;
  padding:5px;
  border:1px solid #006;
  border-radius: 5px;
  color:#006;
  background:linear-gradient(#ccf,#b8b8e8);
  box-shadow:1px 1px 1px 1px rgba(0,0,0,0.4);
}
#patchenumpanel .patchbtn{
  width:130px;
  text-align: left;
}
#patchenumscr{
  overflow-y:scroll;
  height:450px;
}
#splashbase {
  display: block;
  position: fixed; /* Covers the entire screen */
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7); /* Semi-transparent dark overlay */
}

/* Centered splash panel */
#splashpanel {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 700px;
  height: auto;
  max-width: 90%;
  background: linear-gradient(135deg, #3a3f50, #555f77); /* Modern dark UI */
  border: 2px solid #444;
  border-radius: 12px;
  box-shadow: 6px 6px 15px rgba(0, 0, 0, 0.5);
  text-align: center;
  padding: 20px;
  color: antiquewhite;
  display: block;
  flex-direction: column;
  align-items: center;
}

/* Title styling */
#splashpanel h1 {
  font-size: 22px;
  font-weight: bold;
  margin-bottom: 10px;
  color: #ffd;
  text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
}

/* Logo */
#splashpanel img {
  max-width: 150px;
  margin-bottom: 10px;
  display: inline-block; /* Ensures images stay in a row */
  vertical-align: middle; /* Aligns them properly */
}

/* Description text */
#splashpanel p {
  font-size: 14px;
  color: #ddd;
  max-width: 600px;
  margin: 10px auto;
  line-height: 1.5;
}

/* Buttons */
#splashpanel button {
  width: 150px;
  background: linear-gradient(135deg, #446, #668);
  color: #ffd;
  font-size: 14px;
  font-weight: bold;
  border: 1px solid #444;
  border-radius: 6px;
  padding: 10px;
  cursor: pointer;
  transition: background 0.2s ease-in-out;
  margin-top: 15px;
}

#splashpanel button:hover {
  background: linear-gradient(135deg, #668, #88a);
  color: #fff;
}


</style>
</head>
<body>
  <div id="base">
   
    <div id="mainmenu">
      <ul>
        <li>MidiPort <select id="midiport" onchange="SelectPort()"></select></li>
        <li><div style="display:inline-block;width:160px">Device : <span id="device"></span></div><div>FW : <span id="firmver"></span></div></li>
        <li><hr/></li>
        <li><button class="menubtn" id="scanbtn" onclick="Scan()" title="Re-Scan all patches on the device">Scan Patches</button> <button class="menubtn" id="tunerbtn" onclick="Tuner()" title="Toggle Tuner-Mode">Tuner</button></li>
        <li><button class="menubtn" id="instchbtn" onclick="InstallCheck()" title="List the installed effects">Install Check</button> <button class="menubtn" id="autosavebtn" onclick="AutoSave()" title="Save the changes in the browser automatically">AutoSave</button></li>
        <li><button class="menubtn" id="loadbankbtn" onclick="LoadBank()" title="Import all patches from the bank file (.zip)">Import Bank file</button> <button class="menubtn" id="devsavebtn" onclick="SaveAllToDevice()" title="Store all patches to device's memory">Save all patches</button></li>
        <li><button class="menubtn" id="savebankbtn" onclick="SaveBank()" title="Export all patches as a bank file (.zip)">Export Bank file</button> <button class="menubtn" id="usagebtn" onclick="Usage()">How To<br>Use</button></li>
        <li></li>
      </ul>
    </div>
    <div id="patchesbase">
      <table id="patches">
        <tr>
          <td id="1"><button id="1btn">1</button><div id="1nam" class="pnam"></div></td>
          <td id="11"><button id="11btn">11</button><div id="11nam" class="pnam"></div></td>
          <td id="21"><button id="21btn">21</button><div id="21nam" class="pnam"></div></td>
          <td id="31"><button id="31btn">31</button><div id="31nam" class="pnam"></div></td>
          <td id="41"><button id="41btn">41</button><div id="41nam" class="pnam"></div></td>
        </tr>
        <tr>
          <td id="2"><button id="2btn">2</button><div id="2nam" class="pnam"></div></td>
          <td id="12"><button id="12btn">12</button><div id="12nam" class="pnam"></div></td>
          <td id="22"><button id="22btn">22</button><div id="22nam" class="pnam"></div></td>
          <td id="32"><button id="32btn">32</button><div id="32nam" class="pnam"></div></td>
          <td id="42"><button id="42btn">42</button><div id="42nam" class="pnam"></div></td>
        </tr>
        <tr>
          <td id="3"><button id="3btn">3</button><div id="3nam" class="pnam"></div></td>
          <td id="13"><button id="13btn">13</button><div id="13nam" class="pnam"></div></td>
          <td id="23"><button id="23btn">23</button><div id="23nam" class="pnam"></div></td>
          <td id="33"><button id="33btn">33</button><div id="33nam" class="pnam"></div></td>
          <td id="43"><button id="43btn">43</button><div id="43nam" class="pnam"></div></td>
        </tr>
        <tr>
          <td id="4"><button id="4btn">4</button><div id="4nam" class="pnam"></div></td>
          <td id="14"><button id="14btn">14</button><div id="14nam" class="pnam"></div></td>
          <td id="24"><button id="24btn">24</button><div id="24nam" class="pnam"></div></td>
          <td id="34"><button id="34btn">34</button><div id="34nam" class="pnam"></div></td>
          <td id="44"><button id="44btn">44</button><div id="44nam" class="pnam"></div></td>
        </tr>
        <tr>
          <td id="5"><button id="5btn">5</button><div id="5nam" class="pnam"></div></td>
          <td id="15"><button id="15btn">15</button><div id="15nam" class="pnam"></div></td>
          <td id="25"><button id="25btn">25</button><div id="25nam" class="pnam"></div></td>
          <td id="35"><button id="35btn">35</button><div id="35nam" class="pnam"></div></td>
          <td id="45"><button id="45btn">45</button><div id="45nam" class="pnam"></div></td>
        </tr>
        <tr>
          <td id="6"><button id="6btn">6</button><div id="6nam" class="pnam"></div></td>
          <td id="16"><button id="16btn">16</button><div id="16nam" class="pnam"></div></td>
          <td id="26"><button id="26btn">26</button><div id="26nam" class="pnam"></div></td>
          <td id="36"><button id="36btn">36</button><div id="36nam" class="pnam"></div></td>
          <td id="46"><button id="46btn">46</button><div id="46nam" class="pnam"></div></td>
        </tr>
        <tr>
          <td id="7"><button id="7btn">7</button><div id="7nam" class="pnam"></div></td>
          <td id="17"><button id="17btn">17</button><div id="17nam" class="pnam"></div></td>
          <td id="27"><button id="27btn">27</button><div id="27nam" class="pnam"></div></td>
          <td id="37"><button id="37btn">37</button><div id="37nam" class="pnam"></div></td>
          <td id="47"><button id="47btn">47</button><div id="47nam" class="pnam"></div></td>
        </tr>
        <tr>
          <td id="8"><button id="8btn">8</button><div id="8nam" class="pnam"></div></td>
          <td id="18"><button id="18btn">18</button><div id="18nam" class="pnam"></div></td>
          <td id="28"><button id="28btn">28</button><div id="28nam" class="pnam"></div></td>
          <td id="38"><button id="38btn">38</button><div id="38nam" class="pnam"></div></td>
          <td id="48"><button id="48btn">48</button><div id="48nam" class="pnam"></div></td>
        </tr>
        <tr>
          <td id="9"><button id="9btn">9</button><div id="9nam" class="pnam"></div></td>
          <td id="19"><button id="19btn">19</button><div id="19nam" class="pnam"></div></td>
          <td id="29"><button id="29btn">29</button><div id="29nam" class="pnam"></div></td>
          <td id="39"><button id="39btn">39</button><div id="39nam" class="pnam"></div></td>
          <td id="49"><button id="49btn">49</button><div id="49nam" class="pnam"></div></td>
        </tr>
        <tr>
          <td id="10"><button id="10btn">10</button><div id="10nam" class="pnam"></div></td>
          <td id="20"><button id="20btn">20</button><div id="20nam" class="pnam"></div></td>
          <td id="30"><button id="30btn">30</button><div id="30nam" class="pnam"></div></td>
          <td id="40"><button id="40btn">40</button><div id="40nam" class="pnam"></div></td>
          <td id="50"><button id="50btn">50</button><div id="50nam" class="pnam"></div></td>
        </tr>
      </table>
    </div>
    <div id="dspgraph"><div></div><div></div><div></div><div></div><div></div><div></div></div>
<!--    <canvas id="dspgraph" width="20" height="200"></canvas>-->
    <table id="effects">
      <tr>
        <th><button class="fnum" id="fnum1">1</button></th><td id="fnam1" class="fnam"><img id="fimg1" class="fimg"/><img id="full1" class="fimg"/><div id="ftxt1" class="ftxt"></div></td>
        <td><div class="pcell pfocus" id="f1p1"><webaudio-knob id="f1p1k" diameter="40" src="./images/ms50gknob.png" sprites="100"></webaudio-knob><webaudio-switch id="f1p1s" src="./images/switch.png" width="40" height="42"></webaudio-switch><div><div id="f1p1v" class="param"></div><div id="f1p1l"></div></div></div></td>
        <td><div class="pcell" id="f1p2"><webaudio-knob id="f1p2k" diameter="40" src="./images/ms50gknob.png" sprites="100"></webaudio-knob><webaudio-switch id="f1p2s" src="./images/switch.png" width="40" height="42"></webaudio-switch><div><div id="f1p2v" class="param"></div><div id="f1p2l"></div></div></div></td>
        <td><div class="pcell" id="f1p3"><webaudio-knob id="f1p3k" diameter="40" src="./images/ms50gknob.png" sprites="100"></webaudio-knob><webaudio-switch id="f1p3s" src="./images/switch.png" width="40" height="42"></webaudio-switch><div><div id="f1p3v" class="param"></div><div id="f1p3l"></div></div></div></td>
        <td><div class="pcell" id="f1p4"><webaudio-knob id="f1p4k" diameter="40" src="./images/ms50gknob.png" sprites="100"></webaudio-knob><webaudio-switch id="f1p4s" src="./images/switch.png" width="40" height="42"></webaudio-switch><div><div id="f1p4v" class="param"></div><div id="f1p4l"></div></div></div></td>
        <td><div class="pcell" id="f1p5"><webaudio-knob id="f1p5k" diameter="40" src="./images/ms50gknob.png" sprites="100"></webaudio-knob><webaudio-switch id="f1p5s" src="./images/switch.png" width="40" height="42"></webaudio-switch><div><div id="f1p5v" class="param"></div><div id="f1p5l"></div></div></div></td>
        <td><div class="pcell" id="f1p6"><webaudio-knob id="f1p6k" diameter="40" src="./images/ms50gknob.png" sprites="100"></webaudio-knob><webaudio-switch id="f1p6s" src="./images/switch.png" width="40" height="42"></webaudio-switch><div><div id="f1p6v" class="param"></div><div id="f1p6l"></div></div></div></td>
        <td><div class="pcell" id="f1p7"><webaudio-knob id="f1p7k" diameter="40" src="./images/ms50gknob.png" sprites="100"></webaudio-knob><webaudio-switch id="f1p7s" src="./images/switch.png" width="40" height="42"></webaudio-switch><div><div id="f1p7v" class="param"></div><div id="f1p7l"></div></div></div></td>
        <td><div class="pcell" id="f1p8"><webaudio-knob id="f1p8k" diameter="40" src="./images/ms50gknob.png" sprites="100"></webaudio-knob><webaudio-switch id="f1p8s" src="./images/switch.png" width="40" height="42"></webaudio-switch><div><div id="f1p8v" class="param"></div><div id="f1p8l"></div></div></div></td>
        <td><div class="pcell" id="f1p9"><webaudio-knob id="f1p9k" diameter="40" src="./images/ms50gknob.png" sprites="100"></webaudio-knob><webaudio-switch id="f1p9s" src="./images/switch.png" width="40" height="42"></webaudio-switch><div><div id="f1p9v" class="param"></div><div id="f1p9l"></div></div></div></td>
      </tr>
      <tr>
        <th><button class="fnum" id="fnum2">2</button></th><td id="fnam2" class="fnam"><img id="fimg2" class="fimg"/><img id="full2" class="fimg"/><div id="ftxt2" class="ftxt"></div></td>
        <td><div class="pcell" id="f2p1"><webaudio-knob id="f2p1k" diameter="40" src="./images/ms50gknob.png" sprites="100"></webaudio-knob><webaudio-switch id="f2p1s" src="./images/switch.png" width="40" height="42"></webaudio-switch><div><div id="f2p1v" class="param"></div><div id="f2p1l"></div></div></div></td>
        <td><div class="pcell" id="f2p2"><webaudio-knob id="f2p2k" diameter="40" src="./images/ms50gknob.png" sprites="100"></webaudio-knob><webaudio-switch id="f2p2s" src="./images/switch.png" width="40" height="42"></webaudio-switch><div><div id="f2p2v" class="param"></div><div id="f2p2l"></div></div></div></td>
        <td><div class="pcell" id="f2p3"><webaudio-knob id="f2p3k" diameter="40" src="./images/ms50gknob.png" sprites="100"></webaudio-knob><webaudio-switch id="f2p3s" src="./images/switch.png" width="40" height="42"></webaudio-switch><div><div id="f2p3v" class="param"></div><div id="f2p3l"></div></div></div></td>
        <td><div class="pcell" id="f2p4"><webaudio-knob id="f2p4k" diameter="40" src="./images/ms50gknob.png" sprites="100"></webaudio-knob><webaudio-switch id="f2p4s" src="./images/switch.png" width="40" height="42"></webaudio-switch><div><div id="f2p4v" class="param"></div><div id="f2p4l"></div></div></div></td>
        <td><div class="pcell" id="f2p5"><webaudio-knob id="f2p5k" diameter="40" src="./images/ms50gknob.png" sprites="100"></webaudio-knob><webaudio-switch id="f2p5s" src="./images/switch.png" width="40" height="42"></webaudio-switch><div><div id="f2p5v" class="param"></div><div id="f2p5l"></div></div></div></td>        <td><div class="pcell" id="f2p6"><webaudio-knob id="f2p6k" diameter="40" src="./images/ms50gknob.png" sprites="100"></webaudio-knob><webaudio-switch id="f2p6s" src="./images/switch.png" width="40" height="42"></webaudio-switch><div><div id="f2p6v" class="param"></div><div id="f2p6l"></div></div></div></td>
        <td><div class="pcell" id="f2p7"><webaudio-knob id="f2p7k" diameter="40" src="./images/ms50gknob.png" sprites="100"></webaudio-knob><webaudio-switch id="f2p7s" src="./images/switch.png" width="40" height="42"></webaudio-switch><div><div id="f2p7v" class="param"></div><div id="f2p7l"></div></div></div></td>
        <td><div class="pcell" id="f2p8"><webaudio-knob id="f2p8k" diameter="40" src="./images/ms50gknob.png" sprites="100"></webaudio-knob><webaudio-switch id="f2p8s" src="./images/switch.png" width="40" height="42"></webaudio-switch><div><div id="f2p8v" class="param"></div><div id="f2p8l"></div></div></div></td>
        <td><div class="pcell" id="f2p9"><webaudio-knob id="f2p9k" diameter="40" src="./images/ms50gknob.png" sprites="100"></webaudio-knob><webaudio-switch id="f2p9s" src="./images/switch.png" width="40" height="42"></webaudio-switch><div><div id="f2p9v" class="param"></div><div id="f2p9l"></div></div></div></td>
      </tr>
      <tr>
        <th><button class="fnum" id="fnum3">3</button></th><td id="fnam3" class="fnam"><img id="fimg3" class="fimg"/><img id="full3" class="fimg"/><div id="ftxt3" class="ftxt"></div></td>
        <td><div class="pcell" id="f3p1"><webaudio-knob id="f3p1k" diameter="40" src="./images/ms50gknob.png" sprites="100"></webaudio-knob><webaudio-switch id="f3p1s" src="./images/switch.png" width="40" height="42"></webaudio-switch><div><div id="f3p1v" class="param"><input id="f3p1v" disabled/></div><div id="f3p1l"></div></div></div></td>
        <td><div class="pcell" id="f3p2"><webaudio-knob id="f3p2k" diameter="40" src="./images/ms50gknob.png" sprites="100"></webaudio-knob><webaudio-switch id="f3p2s" src="./images/switch.png" width="40" height="42"></webaudio-switch><div><div id="f3p2v" class="param"></div><div id="f3p2l"></div></div></div></td>
        <td><div class="pcell" id="f3p3"><webaudio-knob id="f3p3k" diameter="40" src="./images/ms50gknob.png" sprites="100"></webaudio-knob><webaudio-switch id="f3p3s" src="./images/switch.png" width="40" height="42"></webaudio-switch><div><div id="f3p3v" class="param"></div><div id="f3p3l"></div></div></div></td>
        <td><div class="pcell" id="f3p4"><webaudio-knob id="f3p4k" diameter="40" src="./images/ms50gknob.png" sprites="100"></webaudio-knob><webaudio-switch id="f3p4s" src="./images/switch.png" width="40" height="42"></webaudio-switch><div><div id="f3p4v" class="param"></div><div id="f3p4l"></div></div></div></td>
        <td><div class="pcell" id="f3p5"><webaudio-knob id="f3p5k" diameter="40" src="./images/ms50gknob.png" sprites="100"></webaudio-knob><webaudio-switch id="f3p5s" src="./images/switch.png" width="40" height="42"></webaudio-switch><div><div id="f3p5v" class="param"></div><div id="f3p5l"></div></div></div></td>
        <td><div class="pcell" id="f3p6"><webaudio-knob id="f3p6k" diameter="40" src="./images/ms50gknob.png" sprites="100"></webaudio-knob><webaudio-switch id="f3p6s" src="./images/switch.png" width="40" height="42"></webaudio-switch><div><div id="f3p6v" class="param"></div><div id="f3p6l"></div></div></div></td>
        <td><div class="pcell" id="f3p7"><webaudio-knob id="f3p7k" diameter="40" src="./images/ms50gknob.png" sprites="100"></webaudio-knob><webaudio-switch id="f3p7s" src="./images/switch.png" width="40" height="42"></webaudio-switch><div><div id="f3p7v" class="param"></div><div id="f3p7l"></div></div></div></td>
        <td><div class="pcell" id="f3p8"><webaudio-knob id="f3p8k" diameter="40" src="./images/ms50gknob.png" sprites="100"></webaudio-knob><webaudio-switch id="f3p8s" src="./images/switch.png" width="40" height="42"></webaudio-switch><div><div id="f3p8v" class="param"></div><div id="f3p8l"></div></div></div></td>
        <td><div class="pcell" id="f3p9"><webaudio-knob id="f3p9k" diameter="40" src="./images/ms50gknob.png" sprites="100"></webaudio-knob><webaudio-switch id="f3p9s" src="./images/switch.png" width="40" height="42"></webaudio-switch><div><div id="f3p9v" class="param"></div><div id="f3p9l"></div></div></div></td>
      </tr>
      <tr>
        <th><button class="fnum" id="fnum4">4</button></th><td id="fnam4" class="fnam"><img id="fimg4" class="fimg"/><img id="full4" class="fimg"/><div id="ftxt4" class="ftxt"></div></td>
        <td><div class="pcell" id="f4p1"><webaudio-knob id="f4p1k" diameter="40" src="./images/ms50gknob.png" sprites="100"></webaudio-knob><webaudio-switch id="f4p1s" src="./images/switch.png" width="40" height="42"></webaudio-switch><div><div id="f4p1v" class="param"></div><div id="f4p1l"></div></div></div></td>
        <td><div class="pcell" id="f4p2"><webaudio-knob id="f4p2k" diameter="40" src="./images/ms50gknob.png" sprites="100"></webaudio-knob><webaudio-switch id="f4p2s" src="./images/switch.png" width="40" height="42"></webaudio-switch><div><div id="f4p2v" class="param"></div><div id="f4p2l"></div></div></div></td>
        <td><div class="pcell" id="f4p3"><webaudio-knob id="f4p3k" diameter="40" src="./images/ms50gknob.png" sprites="100"></webaudio-knob><webaudio-switch id="f4p3s" src="./images/switch.png" width="40" height="42"></webaudio-switch><div><div id="f4p3v" class="param"></div><div id="f4p3l"></div></div></div></td>
        <td><div class="pcell" id="f4p4"><webaudio-knob id="f4p4k" diameter="40" src="./images/ms50gknob.png" sprites="100"></webaudio-knob><webaudio-switch id="f4p4s" src="./images/switch.png" width="40" height="42"></webaudio-switch><div><div id="f4p4v" class="param"></div><div id="f4p4l"></div></div></div></td>
        <td><div class="pcell" id="f4p5"><webaudio-knob id="f4p5k" diameter="40" src="./images/ms50gknob.png" sprites="100"></webaudio-knob><webaudio-switch id="f4p5s" src="./images/switch.png" width="40" height="42"></webaudio-switch><div><div id="f4p5v" class="param"></div><div id="f4p5l"></div></div></div></td>
        <td><div class="pcell" id="f4p6"><webaudio-knob id="f4p6k" diameter="40" src="./images/ms50gknob.png" sprites="100"></webaudio-knob><webaudio-switch id="f4p6s" src="./images/switch.png" width="40" height="42"></webaudio-switch><div><div id="f4p6v" class="param"></div><div id="f4p6l"></div></div></div></td>
        <td><div class="pcell" id="f4p7"><webaudio-knob id="f4p7k" diameter="40" src="./images/ms50gknob.png" sprites="100"></webaudio-knob><webaudio-switch id="f4p7s" src="./images/switch.png" width="40" height="42"></webaudio-switch><div><div id="f4p7v" class="param"></div><div id="f4p7l"></div></div></div></td>
        <td><div class="pcell" id="f4p8"><webaudio-knob id="f4p8k" diameter="40" src="./images/ms50gknob.png" sprites="100"></webaudio-knob><webaudio-switch id="f4p8s" src="./images/switch.png" width="40" height="42"></webaudio-switch><div><div id="f4p8v" class="param"></div><div id="f4p8l"></div></div></div></td>
        <td><div class="pcell" id="f4p9"><webaudio-knob id="f4p9k" diameter="40" src="./images/ms50gknob.png" sprites="100"></webaudio-knob><webaudio-switch id="f4p9s" src="./images/switch.png" width="40" height="42"></webaudio-switch><div><div id="f4p9v" class="param"></div><div id="f4p9l"></div></div></div></td>
      </tr>
      <tr>
        <th><button class="fnum" id="fnum5">5</button></th><td id="fnam5" class="fnam"><img id="fimg5" class="fimg"/><img id="full5" class="fimg"/><div id="ftxt5" class="ftxt"></div></td>
        <td><div class="pcell" id="f5p1"><webaudio-knob id="f5p1k" diameter="40" src="./images/ms50gknob.png" sprites="100"></webaudio-knob><webaudio-switch id="f5p1s" src="./images/switch.png" width="40" height="42"></webaudio-switch><div><div id="f5p1v" class="param"></div><div id="f5p1l"></div></div></div></td>
        <td><div class="pcell" id="f5p2"><webaudio-knob id="f5p2k" diameter="40" src="./images/ms50gknob.png" sprites="100"></webaudio-knob><webaudio-switch id="f5p2s" src="./images/switch.png" width="40" height="42"></webaudio-switch><div><div id="f5p2v" class="param"></div><div id="f5p2l"></div></div></div></td>
        <td><div class="pcell" id="f5p3"><webaudio-knob id="f5p3k" diameter="40" src="./images/ms50gknob.png" sprites="100"></webaudio-knob><webaudio-switch id="f5p3s" src="./images/switch.png" width="40" height="42"></webaudio-switch><div><div id="f5p3v" class="param"></div><div id="f5p3l"></div></div></div></td>
        <td><div class="pcell" id="f5p4"><webaudio-knob id="f5p4k" diameter="40" src="./images/ms50gknob.png" sprites="100"></webaudio-knob><webaudio-switch id="f5p4s" src="./images/switch.png" width="40" height="42"></webaudio-switch><div><div id="f5p4v" class="param"></div><div id="f5p4l"></div></div></div></td>
        <td><div class="pcell" id="f5p5"><webaudio-knob id="f5p5k" diameter="40" src="./images/ms50gknob.png" sprites="100"></webaudio-knob><webaudio-switch id="f5p5s" src="./images/switch.png" width="40" height="42"></webaudio-switch><div><div id="f5p5v" class="param"></div><div id="f5p5l"></div></div></div></td>
        <td><div class="pcell" id="f5p6"><webaudio-knob id="f5p6k" diameter="40" src="./images/ms50gknob.png" sprites="100"></webaudio-knob><webaudio-switch id="f5p6s" src="./images/switch.png" width="40" height="42"></webaudio-switch><div><div id="f5p6v" class="param"></div><div id="f5p6l"></div></div></div></td>
        <td><div class="pcell" id="f5p7"><webaudio-knob id="f5p7k" diameter="40" src="./images/ms50gknob.png" sprites="100"></webaudio-knob><webaudio-switch id="f5p7s" src="./images/switch.png" width="40" height="42"></webaudio-switch><div><div id="f5p7v" class="param"></div><div id="f5p7l"></div></div></div></td>
        <td><div class="pcell" id="f5p8"><webaudio-knob id="f5p8k" diameter="40" src="./images/ms50gknob.png" sprites="100"></webaudio-knob><webaudio-switch id="f5p8s" src="./images/switch.png" width="40" height="42"></webaudio-switch><div><div id="f5p8v" class="param"></div><div id="f5p8l"></div></div></div></td>
        <td><div class="pcell" id="f5p9"><webaudio-knob id="f5p9k" diameter="40" src="./images/ms50gknob.png" sprites="100"></webaudio-knob><webaudio-switch id="f5p9s" src="./images/switch.png" width="40" height="42"></webaudio-switch><div><div id="f5p9v" class="param"></div><div id="f5p9l"></div></div></div></td>
      </tr>
      <tr>
        <th><button class="fnum" id="fnum6">6</button></th><td id="fnam6" class="fnam"><img id="fimg6" class="fimg"/><img id="full6" class="fimg"/><div id="ftxt6" class="ftxt"></div></td>
        <td><div class="pcell" id="f6p1"><webaudio-knob id="f6p1k" diameter="40" src="./images/ms50gknob.png" sprites="100"></webaudio-knob><webaudio-switch id="f6p1s" src="./images/switch.png" width="40" height="42"></webaudio-switch><div><div id="f6p1v" class="param"></div><div id="f6p1l"></div></div></div></td>
        <td><div class="pcell" id="f6p2"><webaudio-knob id="f6p2k" diameter="40" src="./images/ms50gknob.png" sprites="100"></webaudio-knob><webaudio-switch id="f6p2s" src="./images/switch.png" width="40" height="42"></webaudio-switch><div><div id="f6p2v" class="param"></div><div id="f6p2l"></div></div></div></td>
        <td><div class="pcell" id="f6p3"><webaudio-knob id="f6p3k" diameter="40" src="./images/ms50gknob.png" sprites="100"></webaudio-knob><webaudio-switch id="f6p3s" src="./images/switch.png" width="40" height="42"></webaudio-switch><div><div id="f6p3v" class="param"></div><div id="f6p3l"></div></div></div></td>
        <td><div class="pcell" id="f6p4"><webaudio-knob id="f6p4k" diameter="40" src="./images/ms50gknob.png" sprites="100"></webaudio-knob><webaudio-switch id="f6p4s" src="./images/switch.png" width="40" height="42"></webaudio-switch><div><div id="f6p4v" class="param"></div><div id="f6p4l"></div></div></div></td>
        <td><div class="pcell" id="f6p5"><webaudio-knob id="f6p5k" diameter="40" src="./images/ms50gknob.png" sprites="100"></webaudio-knob><webaudio-switch id="f6p5s" src="./images/switch.png" width="40" height="42"></webaudio-switch><div><div id="f6p5v" class="param"></div><div id="f6p5l"></div></div></div></td>
        <td><div class="pcell" id="f6p6"><webaudio-knob id="f6p6k" diameter="40" src="./images/ms50gknob.png" sprites="100"></webaudio-knob><webaudio-switch id="f6p6s" src="./images/switch.png" width="40" height="42"></webaudio-switch><div><div id="f6p6v" class="param"></div><div id="f6p6l"></div></div></div></td>
        <td><div class="pcell" id="f6p7"><webaudio-knob id="f6p7k" diameter="40" src="./images/ms50gknob.png" sprites="100"></webaudio-knob><webaudio-switch id="f6p7s" src="./images/switch.png" width="40" height="42"></webaudio-switch><div><div id="f6p7v" class="param"></div><div id="f6p7l"></div></div></div></td>
        <td><div class="pcell" id="f6p8"><webaudio-knob id="f6p8k" diameter="40" src="./images/ms50gknob.png" sprites="100"></webaudio-knob><webaudio-switch id="f6p8s" src="./images/switch.png" width="40" height="42"></webaudio-switch><div><div id="f6p8v" class="param"></div><div id="f6p8l"></div></div></div></td>
        <td><div class="pcell" id="f6p9"><webaudio-knob id="f6p9k" diameter="40" src="./images/ms50gknob.png" sprites="100"></webaudio-knob><webaudio-switch id="f6p9s" src="./images/switch.png" width="40" height="42"></webaudio-switch><div><div id="f6p9v" class="param"></div><div id="f6p9l"></div></div></div></td>
      </tr>
    </table>
    <div id="popupeditpanel" class="popup"></div>
  </div>

  <ul id="popuppatch" class="popup">
    <li><a onclick="PopupPatchOverwrite()">Overwrite</a></li>
    <li><a onclick="PopupPatchExchange()">Exchange</a></li>
    <li><hr/></li>
    <li><a onclick="PopupPatchCancel()">Cancel</a></li>
  </ul>

  <ul id="popuppatch2" class="popup">
    <li><a onclick="PopupPatchCopy()">Copy</a></li>
    <li><a onclick="PopupPatchPaste()">Paste</a></li>
    <li><a onclick="PopupPatchDelete()">Delete</a></li>
    <li><a onclick="PopupPatchRename()">Rename</a></li>
    <li><hr/></li>
    <li><a onclick="ExportPatch()">Export Patch to file</a></li>
    <li><a onclick="ImportPatch()">Import Patch from file</a></li>
    <li><hr/></li>
    <li><a onclick="ShowPatch()">Show Patch as text</a></li>
    <li><a onclick="ImportText()">Import Patch from text</a><li>
      <li><hr/></li>
    <li><a onclick="SavePatchToDevice()">Save Patch to Device</a></li>
    <li><hr/></li>
    <li><a onclick="PopupPatchCancel2()">Cancel</a></li>
  </ul>

  <ul id="popupeffect" class="popup">
    <li><a onclick="PopupEffectReplace()">Add/Replace</a></li>
    <li><hr/></li>
    <li><a onclick="PopupEffectInsert()">Insert Space</a></li>
    <li><a onclick="PopupEffectUp()">Move Up</a></li>
    <li><a onclick="PopupEffectDown()">Move Down</a></li>
    <li><a onclick="PopupEffectDelete()">Delete</a></li>
    <li><hr/></li>
    <li><a onclick="PopupEffectCancel()">Cancel</a></li>
  </ul>

  <div id="patchenum" class="modalbase">
    <div id="patchenumpanel">
      Load Patch Select from Bank:
      <table id="patchenumlist">
        <tr><td></td><td></td><td></td><td></td><td></td></tr>
        <tr><td></td><td></td><td></td><td></td><td></td></tr>
        <tr><td></td><td></td><td></td><td></td><td></td></tr>
        <tr><td></td><td></td><td></td><td></td><td></td></tr>
        <tr><td></td><td></td><td></td><td></td><td></td></tr>
        <tr><td></td><td></td><td></td><td></td><td></td></tr>
        <tr><td></td><td></td><td></td><td></td><td></td></tr>
        <tr><td></td><td></td><td></td><td></td><td></td></tr>
        <tr><td></td><td></td><td></td><td></td><td></td></tr>
        <tr><td></td><td></td><td></td><td></td><td></td></tr>
      </table>
      <button onclick="this.parentNode.parentNode.style.display='none'" style="width:120px">Cancel</button>
    </div>
  </div>

  <div id="effectpanelbase" class="modalbase">
    <div id="effectpanel">
      <div id="effectpanelmsg" style="color: whitesmoke; text-transform: uppercase;">Add/Replace Effect</div>
      <div id="effectpanelscr">
        <div id="effectpanellist">
          <table>
            <tr>
              <th>COMP</th><td><div class="efgrp" id="efCOMP"></div></td>
            </tr>
            <tr>
              <th>FILTER</th><td><div class="efgrp" id="efFILTER"></div></td>
            </tr>
            <tr>
              <th>DRIVE</th><td><div class="efgrp" id="efDRIVE"></div></td>
            </tr>
            <tr>
              <th>AMP</th><td><div class="efgrp" id="efAMP"></div></td>
            </tr>
            <tr>
              <th>MOD</th><td><div class="efgrp" id="efMOD"></div></td>
            </tr>
            <tr>
              <th>SFX</th><td><div class="efgrp" id="efSFX"></div></td>
            </tr>
            <tr>
              <th>DELAY</th><td><div class="efgrp" id="efDELAY"></div></td>
            </tr>
            <tr>
              <th>REVERB</th><td><div class="efgrp" id="efREVERB"></div></td>
            </tr>
          </table>
        </div>
      </div>
      <button onclick="EffectPanelCancel()" style="width:120px;height:30px;margin:5px;text-transform: uppercase;">Cancel</button>
      <button onclick="inst.Start()" style="width:120px;height:30px;margin:5px;text-transform: uppercase;">Install Check</button>
      <input type="checkbox" onchange="inst.ShowAll(this.checked)" style="width:12px" id="showall"/><label for="showall" style="font-size:12px;color: whitesmoke;">Show All MS series effects</label>
    </div>
  </div>

  <div id="splashbase" class="modalbase">
    <div id="splashpanel">
      <h1>Zoom MS Utility MS-50G / MS-60B / MS-70CDR</h1>
      <br/>
      <img src="./images/g200kg160x80.png" style="margin:0px 10px"/> <img src="./images/50g.png" style="width:45px;margin:0px 10px"/> <img src="./images/60b.png" style="width:45px;margin:0px 10px"/> <img src="./images/70cdr.png" style="width:45px;margin:0px 10px"/><br/>
      <p>This is a browser based ZOOM MS-50G / 60B / 70CDR patch editor<br/>
      Launch this page with latest Chrome after connect ZOOM MS-50G / 60B / 70CDR via USB.</br>
      To use on iPad - open using browser WEB MIDI
      <p>これはブラウザで動作する ZOOM MS-50G / 60B / 70CDR 用のパッチエディタです<br/>
        ZOOM MS-50G / 60B / 70CDR を USB で接続した後、このページを起動してください。</p>
      <hr style="clear:both"/>
      <p style="font-size:12px">
        <div id="github2" style="text-decoration:underline;cursor:pointer">GitHub (original) repository</DIV>
      </p>
      <button onclick="document.getElementById('splashbase').style.display='none';Scan()" style="width:150px;height:40px" title="Start Patch Editor">START</button>
      <button onclick="Usage()" style="width:150px;height:40px" title="How to use this patch editor">How To Use</button>
    </div>
  </div>

  <div id="usagebase" class="modalbase">
    <div id="usagepanel">
      <button onclick="ShowDoc('en')" style="width:80px">English</button> | <button onclick="ShowDoc('ja')" style="width:80px">Japanese</button>
      <div id="usagescr">
        <div class="doc_en">
          <h3>What's new v1.0.2</h3>
          <ul>
            <li>Added stand-alone version</li>
          </ul>
          <h3>v1.0.1</h3>
          <ul>
            <li>Fix the switch behavior when clicking</li>
            <li>The parameter display is now the same as the device display when the DELAY's Time is tempo sync</li>
            <li>By double-clicking the parameter value display, numerical values edit from the keyboard is enabled</li>
          </ul>
          <h3>Usage</h3>
          <ul>
            <li>Launch<br/>
              <ul>
                <li>Connect PC/Mac to MS-50G / 60B / 70CDR via USB.</li>
                <li>Launch this page. You should use Latest Chrome. Once close all Chrome window if you have MidiPort detection problem.</li>
                <li>Press accept if 'MIDI device' permission dialog is displayed. (press keyboard icon on right edge of address bar and retry if you make a mistake)</li>
                <li>After splash screen, all patches and effects with parameters are displayed.</li>
              </ul>
            </li>
            <li>Patches<br/>
              <ul>
                <li>Click patch name to select.</li>
                <li>Right-click (ctrl+click for Mac) or patch number button will show Context-menu.</li>
                <li>From context-menu, You can do Copy/Paste/Rename/etc patches.</li>
                <li>Patches are draggable to another position for overwrite/exchange.</li>
                <li>By context menu - ExportToFile/ImportFromFile, each patch can be backup/restore to local file.</li>
                <li>By context menu - SavePatchToDevice, force each patch to be stored to device's memory.</li>
                <li>The default folder for exporting patches (as well as banks) is determined by the browser specification.
                  I recommend to set to "Ask where to save each file before downloading" in Chrome settings-advanced-downloads.</li>
                <li>If you want to exchange patch data with BBS etc, 'Show Patch as text' and 'Import Patch from text' in the context menu are useful.</li>
                <li>'Show Patch as text' displays a patch expressed in text (hex string), it can be used for copying, saving, posting to BBS etc.</li>
                <li>'Import Patch from text' will load patches by entering the text displayed in 'Show Patch as text'.</li>
                <li>'Import Patch from text' also support the format of MS-50G patch page in 'http://guitarpatches.com'. Copy entire text by (Ctrl-A / Ctrl-C) in patch page, and paste to Patch editor's input field</li>
              </ul>
            </li>
            <li>Effects<br/>
              <ul>
                <li>In the bottom row, 6 effects (4 in 60B) in use are displayed</li>
                <li>Click effect name to switch effect/bypass</li>
                <li>Effects are draggable to another position to change order</li>
                <li>From right-click or number-button context menu, each effect can be add/move/del</li>
                <li>Each parameter can be edit by drag(coarse)/shift-drag(fine)</li>
                <li>Keyboard Up/Down to increase/decrease(fine), PageUp/PageDown(Shift+PageUp/Shift+PageDown) to increase/decrease(coarse) the value</li>
                <li>Mouse wheel and Shift+wheel are also available to value edit</li>
                <li>Also, numerical edit from the keyboard by double-clicking the displayed value</li>
              </ul>
            </li>
            <li>Bank<br/>
              <ul>
                <li>by Export Bank/Import Bank buttons, all 50 patches can be save/load as zipped one file.</li>
                <li>bank file is a .zip file that contains 50 patch files. It can be edit as normal .zip file if you need.</li>
                <li>When a bank file is selected when one patch file loading, a list in the bank file is displayed, and one patch can be selected from among them.</li>
              </ul>
            </li>
            <li>Operation on the device<br/>
              <ul>
                <li>You can use both the patch editor and the operation on the device. The patch selection and parameter adjustment on the device are also reflected in the patch editor.</li>
                <li>It is also convenient to adjust parameters with the physical knob on the device while looking at the patch editor screen.</li>
              </ul>
            </li>
            <li>AutoSave<br/>
              <ul>
                <li>Autosave mode is defaultly ON. But this is not automatically linked to device's "AUTOSAVE" mode. It is recommended to set according to device's "AUTOSAVE" mode.</li>
                <li>In "AutoSave On" mode, patch replacement etc on the browser will be automatically stored to the device's memory.</li>
                <li>If AutoSave is Off, patch replacement etc in the browser is not stored to device's memory until pressing the Save all patches button or Context-menu - SavePatchToDevice for each patch.</li>
                <li>Note that device's "AUTOSAVE" mode is independent to this behavior. A patch may be stored to memory by operation of device itself.</li>
                <li>"Save all patches" button will force all 50 patches to be stored to device's memory.</li>
              </ul>
            </li>
            <li>DSP consumption<br/>
              <ul>
                <li>The green or red bars displayed next to each effect represent approximate DSP consumption.</li>
                <li>It is approximated value and not strictly accurate, but in general, red means that the effect consumes more than 50% of DSP and yellow means more than 30%.</li>
              </ul>
            </li>
            <li>Install check<br/>
              <ul>
                <li>With MS-50G ver 3, you can select the effects to be installed. By 'Install Check' button, you can check which effect is installed.</li>
                <li>In the effect list panel, the one with the green background is the actually installed effect on the device.</li>
              </ul>
            </li>
            <li>Keyboard<br/>
              <ul>
                <li>Keyboard Left/Right is assigned to patch Down/Up, 'a'-'t':patch1-patch20, 'A'-'T':patch21-patch40 '1'-'9','0':patch41-patch50</li>
                <li>Keyboard 'F1'-'F6' is assigned to On/Off each effect.</li>
                <li>Keybeard 'F9' is assigned to Tuner mode On/Off.</li>
              </ul>
            </li>
            <li>Usage in online / offline environment<br/>
              <ul>
                <li>Online version : <a href="https://g200kg.github.io/zoom-ms-utility/" target="_blank">https://g200kg.github.io/zoom-ms-utility/</a></li>
                <li>Standalone version : Offline executables are available in the repository <a href="https://github.com/g200kg/zoom-ms-utility" target="_blank">zoom-ms-utility</a>,
                  <ul>
                    <li>Windows (x64) : dist/zoom-ms-utility-XXX-win-x64</li>
                    <li>Mac (x64) : dist/zoom-ms-utility-XXX-mac-x64</li>
                  </ul>
                </li>
              </ul>
            </li>
        </ul>
        </div>
        <div class="doc_ja">
          <h3>What's new v1.0.2</h3>
          <ul>
            <li>スタンドアローンバージョンを追加しました</li>
          </ul>
          <h3>v1.0.1</h3>
          <ul>
            <li>スイッチをクリックした時の挙動を修正しました</li>
            <li>ディレイのTimeがテンポシンクになっている場合のパラメータ表示をデバイスの表示に合わせました</li>
            <li>パラメータ値表示をダブルクリックする事で、キーボードからの数値編集ができるようになりました。</li>
          </ul>
          <h3>使い方</h3>
          <ul>
            <li>起動<br/>
              <ul>
                <li>PC または Mac と MS-50G / 60B / 70CDR を USB で接続します</li>
                <li>最新版の Chrome を使用してこのページを起動します。MIDIポートの検出関係で問題がある場合には一度 Chrome の全てのウィンドウを閉じてください</li>
                <li>"MIDIデバイス" のアクセスに関するダイアログが出た場合は、許可してください。(やり直す場合はアドレスバーの右端にあるキーボードのアイコンをクリックします)</li>
                <li>スプラッシュスクリーンの後、パッチの一覧とエフェクトパラメータが表示されます。</li>
              </ul>
            </li>
            <li>パッチ<br/>
              <ul>
                <li>パッチ名をクリックすると選択されます</li>
                <li>右クリック(MacではCtrl+クリック) またはパッチ番号のボタンを押すとコンテキストメニューが表示されます</li>
                <li>コンテキストメニューからはパッチの Copy / Paste / Rename 等が実行できます</li>
                <li>パッチのポジションを変更するにはパッチ名をドラッグしてください。ドロップした際に上書きか交換を選択できます</li>
                <li>コンテキストメニューの Export To File / Import From File はパッチをローカルファイルに保存/読込を行います</li>
                <li>コンテキストメニューの Save Patch To Device はパッチを本体のメモリに名前を付けて保存します</li>
                <li>ExportToFile で保存されるフォルダを毎回選択するには Chrome のダウンロードの詳細設定を変更してください</li>
                <li>BBS等でパッチデータを交換したい場合はコンテキストメニューの Show Patch as text と Import Patch from text が便利です。</li>
                <li>Show Patch as text は、パッチをテキスト(16進文字列)で表現したものを表示しますので、コピーして保存、BBS等への投稿に使用してください。</li>
                <li>Import from text は、入力欄に Show Patch as text で表示されたテキストを入力する事でパッチをロードできます。</li>
                <li>また Import from text は http://guitarpatches.com の MS-50G 用のパッチのページをそのままコピー (Ctrl-A / Ctrl-C) したものを貼り付ける事もできます。</li>
              </ul>
            </li>
            <li>エフェクト<br/>
              <ul>
                <li>下段には6個(60Bでは4個)の使用中のエフェクトが表示されます</li>
                <li>エフェクト名をクリックすると、エフェクトのオン/オフが切り替わります</li>
                <li>エフェクト名をドラッグする事で順番を入れ替える事ができます</li>
                <li>エフェクト名を右クリックまたはエフェクト番号のボタンを押すとコンテキストメニューが表示され、エフェクトの追加や削除、移動ができます</li>
                <li>エフェクトの各パラメータの調整はドラッグ(微調整はShift + ドラッグ)で行います</li>
                <li>またはキーボードの上/下で値の増減、PageUp/PageDown(Shift+上/下) で値のおおまかな増減ができます</li>
                <li>また、マウスホイールの操作でパラメータ調整を行う事もできます。微調整は (Shift + マウスホイール)で行います</li>
                <li>更に、表示されている値をダブルクリックする事でキーボードからの数値入力を行う事もできます</li>
              </ul>
            </li>
            <li>バンク<br/>
              <ul>
                <li>Export Bank/ Import Bankのボタンで50個のパッチをまとめてファイルへの保存/読込ができます</li>
                <li>バンクファイルはパッチファイルを.zipにまとめたものです。zipファイルの中身として入っているパッチファイルを入れ替える等の編集をしても構いません</li>
                <li>1つのパッチファイルのインポート時にバンクファイルを選択した場合はバンクファイル内の一覧が表示され、その中から選択する事ができます</li>
              </ul>
            </li>
            <li>本体での操作<br/>
              <ul>
                <li>パッチエディタと本体での操作を併用する事もできます。本体でのパッチの選択やパラメータ調整などもパッチエディタに反映されます。</li>
                <li>パッチエディタの画面を見ながら本体のノブでパラメータの調整を行うという使い方も可能です</li>
              </ul>
            </li>
            <li>オートセーブ<br/>
              <ul>
                <li>AutoSaveモードはデフォルトでONになっており、AutoSaveボタンでON/OFFできますが、本体のAUTO SAVE 機能とは自動的にはリンクしていません。本体の AUTO SAVE 機能のON/OFFと合わせて使用してください。</li>
                <li>オートセーブ ON では、ブラウザ上でパッチの入れ替え等を行った場合に自動的に本体のメモリに保存を行います</li>
                <li>オートセーブ OFF の場合はブラウザ上のパッチの入れ替え等はSave all patches ボタンまたはそれぞれのパッチに対してコンテキストメニューの Save Patch To Deviceを行うまで保存されません</li>
                <li>ただし本体がAUTOSAVEモードの場合には本体でのパッチ操作により保存されます</li>
                <li>Save all patches ボタンは 50個すべてのパッチを本体メモリに保存します</li>
              </ul>
            </li>
            <li>DSP消費<br/>
              <ul>
                <li>各エフェクトの横に表示される緑や赤のバーはDSPの消費量の概算を表します</li>
                <li>おおよその見積もりの値ですので厳密に正確ではありませんが、赤はDSPを50%以上、黄色は30%以上をそのエフェクトが消費する事を表します</li>
              </ul>
            </li>
            <li>インストールチェック<br/>
              <ul>
                <li>MS-50G ver3 では、本体にインストールするエフェクトを選択できるようになりましたが、"Install Check"ボタンでどのエフェクトがインストールされているかを確認する事ができます。</li>
                <li>エフェクトの一覧画面で背景が緑のものが実際にデバイス上にインストールされているエフェクトになります</li>
              </ul>
            </li>
            <li>キーボード<br/>
              <ul>
                <li>左右キーはパッチの上下に割り当てられています。またキーの 'a'～'t'はパッチ1～20、'A'～'T'はパッチ21～40、'1'～'9','0'はパッチ41～50に割り当てられています</li>
                <li>キーボードの 'F1' ～ 'F6' はエフェクトの1～6のオン/オフを切り替えます</li>
                <li>キーボードの'F9'はチューナーのオン/オフを切り替えます</li>
              </ul>
            </li>
            <li>オンライン / オフラインでの使用<br/>
              <ul>
                <li>オンライン版 : <a href="https://g200kg.github.io/zoom-ms-utility/" target="_blank">https://g200kg.github.io/zoom-ms-utility/</a></li>
                <li>スタンドアローン版 : オフライン環境で動作する実行ファイルが、リポジトリ <a href="https://github.com/g200kg/zoom-ms-utility" target="_blank">zoom-ms-utility</a> にあります。
                  <ul>
                    <li>Windows (x64) : dist/zoom-ms-utility-1.0.2-win-x64</li>
                    <li>Mac (x64) : dist/zoom-ms-utility-1.0.2-mac-x64</li>
                  </ul>
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
      <button onclick="Usage()">close</button>
    </div>
  </div>

  <div id="textareabase" class="modalbase">
    <div id="textareapanel">
      <div id="textareamsg"></div>
      <textarea id="textareatext"></textarea><br/>
      <button id="texareacancel" onclick="this.parentNode.parentNode.style.display='none'">Cancel</button> <button id="textareaok">Ok</button>
    </div>
  </div>

  <div id="inputbase" class="modalbase">
    <div id="inputpanel">
      <div id="inputmsg"></div>
      <input id="inputtext"/><br/>
      <button id="inputcancel" onclick="this.parentNode.parentNode.style.display='none'">Cancel</button> <button id="inputok">Ok</button>
    </div>
  </div>

  <div id="confirmbase" class="modalbase">
    <div id="confirmpanel">
      <div id="confirmmsg"></div>
      <button id="confirmcancel" onclick="this.parentNode.parentNode.style.display='none'">Cancel</button> <button id="confirmok">Ok</button>
    </div>
  </div>

  <div id="waitbase" class="modalbase">
    <div id="waitpanel">
      <div id="waitmsg"></div>
    </div>
  </div>

  <div id="alertbase" class="modalbase">
    <div id="alertpanel">
      <div id="alertmsg"></div>
      <button id="alertok">Ok</button>
    </div>
  </div>
</body>
</html>
